---
phase: 100-opencode-ui-parity
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/routes/models.ts
  - apps/web/lib/api/hooks/use-models.ts
  - apps/web/app/(app)/dashboard/dashboard-client.tsx
autonomous: true

must_haves:
  truths:
    - "Big Pickle appears in model dropdown under 'OpenCode Zen' provider"
    - 'Big Pickle is selected by default when no preference set'
    - "Model ID is 'big-pickle' (not 'opencode/big-pickle')"
  artifacts:
    - path: 'apps/api/src/routes/models.ts'
      provides: 'Big Pickle with correct ID and provider'
      contains: 'big-pickle'
    - path: 'apps/web/lib/api/hooks/use-models.ts'
      provides: 'OpenCode Zen at top of groupedByProvider'
  key_links:
    - from: 'dashboard-client.tsx'
      to: 'useModels hook'
      via: 'groupedByProvider includes OpenCode Zen first'
---

<objective>
Fix Big Pickle model to appear correctly in the model selector

Purpose: Big Pickle is OpenCode's stealth model available via OpenCode Zen. The model ID is just `big-pickle` (not `opencode/big-pickle`) and the provider should display as "OpenCode Zen". It's free and should be the default.

Output: Big Pickle visible and selectable in model dropdown, grouped under "OpenCode Zen"
</objective>

<execution_context>
@/Users/dylansteck/.config/opencode/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
From https://opencode.ai/zen/v1/models:
- Model ID: `big-pickle`
- owned_by: `opencode`
- Provider display name: "OpenCode Zen"
- Free model (input/output both free)
- 200K context window, 128K max output

Current FALLBACK_MODELS has wrong ID (`opencode/big-pickle`) and wrong provider name.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix model data in models.ts</name>
  <files>apps/api/src/routes/models.ts</files>
  <action>
Update FALLBACK_MODELS to use correct Big Pickle info:

```typescript
// Default model if no preference set - Big Pickle (free stealth model via OpenCode Zen)
const DEFAULT_MODEL = 'big-pickle'

// Fallback static model list when OpenCode is unavailable
// Ordered by recommendation - default model first
const FALLBACK_MODELS = [
  {
    id: 'big-pickle',
    name: 'Big Pickle',
    provider: 'OpenCode Zen',
    description: 'Free stealth model optimized for coding agents (200K context)',
    contextWindow: 200000,
    maxTokens: 128000,
    isDefault: true,
  },
  {
    id: 'anthropic/claude-sonnet-4-20250514',
    name: 'Claude Sonnet 4',
    provider: 'Anthropic',
    description: 'Latest balanced Claude model',
  },
  {
    id: 'anthropic/claude-opus-4-20250514',
    name: 'Claude Opus 4',
    provider: 'Anthropic',
    description: 'Most capable Claude model',
  },
  {
    id: 'anthropic/claude-3-5-sonnet-20241022',
    name: 'Claude 3.5 Sonnet',
    provider: 'Anthropic',
    description: 'Fast and intelligent',
  },
  {
    id: 'openai/gpt-4o',
    name: 'GPT-4o',
    provider: 'OpenAI',
    description: 'Latest GPT-4 multimodal model',
  },
  {
    id: 'openai/gpt-4o-mini',
    name: 'GPT-4o Mini',
    provider: 'OpenAI',
    description: 'Fast and affordable',
  },
  {
    id: 'google/gemini-2.0-flash',
    name: 'Gemini 2.0 Flash',
    provider: 'Google',
    description: 'Fast multimodal model',
  },
  {
    id: 'google/gemini-1.5-pro',
    name: 'Gemini 1.5 Pro',
    provider: 'Google',
    description: 'Advanced reasoning',
  },
]
```

Also update the validateModelWithFallback function to handle both old and new IDs for backwards compatibility:

```typescript
function validateModelWithFallback(modelId: string): boolean {
  // Handle both new ID (big-pickle) and old ID (opencode/big-pickle)
  if (modelId === 'opencode/big-pickle') return true
  return FALLBACK_MODELS.some((m) => m.id === modelId)
}
```

  </action>
  <verify>
`curl http://localhost:8787/models/available | jq` should show Big Pickle first with provider "OpenCode Zen"
  </verify>
  <done>Big Pickle has correct ID (big-pickle) and provider (OpenCode Zen)</done>
</task>

<task type="auto">
  <name>Task 2: Fix provider grouping order in use-models.ts</name>
  <files>apps/web/lib/api/hooks/use-models.ts</files>
  <action>
Update the groupedByProvider to ensure OpenCode Zen appears first:

```typescript
'use client'

import useSWR from 'swr'
import useSWRMutation from 'swr/mutation'
import { fetcher, apiUrl, post } from '../client'
import type { ModelInfo, DefaultModelResponse } from '../types'

// Provider display order - OpenCode Zen first
const PROVIDER_ORDER = ['OpenCode Zen', 'Anthropic', 'OpenAI', 'Google', 'Other']

/**
 * Hook to fetch available AI models
 */
export function useModels() {
  const { data, error, isLoading, mutate } = useSWR<ModelInfo[]>(apiUrl('/models/available'), fetcher, {
    revalidateOnFocus: false,
    dedupingInterval: 60000, // Cache for 1 minute
  })

  // Group models by provider with guaranteed order
  const groupedByProvider = (data ?? []).reduce<Record<string, ModelInfo[]>>((acc, model) => {
    const provider = model.provider || 'Other'
    if (!acc[provider]) acc[provider] = []
    acc[provider].push(model)
    return acc
  }, {})

  // Sort by provider order
  const sortedGrouped = PROVIDER_ORDER.reduce<Record<string, ModelInfo[]>>((acc, provider) => {
    if (groupedByProvider[provider]?.length > 0) {
      acc[provider] = groupedByProvider[provider]
    }
    return acc
  }, {})

  // Add any providers not in PROVIDER_ORDER at the end
  Object.entries(groupedByProvider).forEach(([provider, models]) => {
    if (!sortedGrouped[provider] && models.length > 0) {
      sortedGrouped[provider] = models
    }
  })

  return {
    models: data ?? [],
    groupedByProvider: sortedGrouped,
    isLoading,
    isError: !!error,
    error,
    mutate,
  }
}

// ... rest of file unchanged
```

  </action>
  <verify>
In browser console on dashboard, check that `groupedByProvider` has "OpenCode Zen" as first key.
  </verify>
  <done>Provider grouping shows OpenCode Zen first</done>
</task>

<task type="auto">
  <name>Task 3: Update dashboard default model selection</name>
  <files>apps/web/app/(app)/dashboard/dashboard-client.tsx</files>
  <action>
Update the default model selection logic to find Big Pickle by the new ID:

```typescript
// Set default model once loaded - prefer Big Pickle (free stealth model via OpenCode Zen)
useEffect(() => {
  if (!selectedModel && models.length > 0) {
    // Find Big Pickle as the preferred default (new ID format)
    const preferredDefault = models.find((m) => m.id === 'big-pickle')
    // Or find any model marked as default
    const markedDefault = models.find((m) => m.isDefault)
    // Fall back to first model
    setSelectedModel(preferredDefault || markedDefault || models[0])
  }
}, [models, selectedModel])
```

Also update the session creation to use the correct model ID:

```typescript
const handleCreate = async (data: { repoOwner: string; repoName: string; model?: string }) => {
  try {
    const newSession = await createSession({
      userId,
      repoOwner: data.repoOwner,
      repoName: data.repoName,
      // Use selected model ID directly (big-pickle, not opencode/big-pickle)
      model: data.model || selectedModel?.id || 'big-pickle',
    })
    // ...
  }
}
```

  </action>
  <verify>
1. Open dashboard with fresh browser
2. Model selector should show "Big Pickle" as selected
3. Dropdown should show "OpenCode Zen" as first group
4. Creating a session should use model ID "big-pickle"
  </verify>
  <done>Dashboard defaults to Big Pickle and sends correct model ID</done>
</task>

</tasks>

<verification>
1. `curl http://localhost:8787/models/available` returns Big Pickle first with provider "OpenCode Zen"
2. Dashboard model dropdown shows "OpenCode Zen" group at top
3. Big Pickle is auto-selected as default
4. Creating a session sends model: "big-pickle" (check network tab)
</verification>

<success_criteria>

- Big Pickle ID is `big-pickle` (not `opencode/big-pickle`)
- Provider displays as "OpenCode Zen"
- OpenCode Zen group appears first in dropdown
- Big Pickle is default selection
- Sessions created with Big Pickle work correctly
  </success_criteria>

<output>
After completion, create `.planning/phases/100-opencode-ui-parity/100-01-SUMMARY.md`
</output>
