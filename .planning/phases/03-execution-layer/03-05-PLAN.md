---
phase: 03-execution-layer
plan: 05
type: execute
wave: 3
depends_on: ["03-01"]
files_modified:
  - apps/api/src/routes/models.ts
  - apps/api/src/lib/opencode.ts
  - apps/web/components/model/model-selector.tsx
  - apps/web/app/settings/page.tsx
  - apps/web/components/session/create-session-dialog.tsx
  - apps/api/src/durable-objects/session.ts
  - apps/api/src/index.ts
  - apps/web/package.json
  - apps/web/components/session/session-panel.tsx
autonomous: true

must_haves:
  truths:
    - "User can set default model in settings page"
    - "User can override model when creating session"
    - "Session shows current model in side panel"
    - "Model can't be changed while agent is generating"
    - "Available models fetched from OpenCode API"
  artifacts:
    - path: "apps/api/src/routes/models.ts"
      provides: "Model listing and selection API"
      exports: ["GET /models", "GET /models/available"]
    - path: "apps/web/components/model/model-selector.tsx"
      provides: "Model selection dropdown"
      exports: ["ModelSelector"]
    - path: "apps/api/src/durable-objects/session.ts"
      provides: "Session model storage"
      contains: ["model", "setModel()", "getModel()"]
  key_links:
    - from: "ModelSelector"
      to: "OpenCode config.providers() API"
      via: "GET /api/models/available"
      pattern: "providers.*models"
    - from: "SessionDO"
      to: "OpenCode session"
      via: "model passed to session.update()"
      pattern: "session\.update.*model"
---

<objective>
Implement AI model selection per CONTEXT.md: Global user preference with per-session override. Settings page for default model, session creation dialog for override. Display current model in session UI. Block changes while agent generating. Use OpenCode SDK's config.providers() to get available models (75+ providers).

Purpose: Let users choose their preferred AI model (Claude, GPT, Gemini, etc.) for agent tasks.

Output: Model selection API, ModelSelector component, settings integration, session model storage.
</objective>

<execution_context>
@/Users/dylansteck/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/dylansteck/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-execution-layer/03-CONTEXT.md
@.planning/phases/03-execution-layer/03-RESEARCH.md
@.planning/phases/03-execution-layer/03-01-SUMMARY.md

# Existing files

@apps/api/src/lib/opencode.ts
@apps/api/src/durable-objects/session.ts
@apps/web/components/session/create-session-dialog.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add model API and extend OpenCode wrapper</name>
  <files>
    apps/api/src/routes/models.ts
    apps/api/src/lib/opencode.ts
    apps/api/src/index.ts
  </files>
  <action>
    1. Extend apps/api/src/lib/opencode.ts:
       - Add `getAvailableModels()` - Calls config.providers() and flattens all models
       - Add `validateModel(modelId: string)` - Check if model is available
       - Add `switchModel(sessionId: string, newModel: string)` - Update OpenCode session model
       - Return model info: { id, name, provider, description }
    
    2. Create apps/api/src/routes/models.ts:
       - `GET /models/available` - List all available models from OpenCode
         - Query OpenCode SDK config.providers()
         - Return: [{ id: "anthropic/claude-sonnet-4", name: "Claude Sonnet 4", provider: "Anthropic" }]
       - `GET /models/default` - Get user's default model preference (from DB)
       - `POST /models/default` - Set user's default model
       - `POST /sessions/:id/model` - Set model for specific session (override)
    
    3. Register routes in apps/api/src/index.ts
    
    4. Pattern from RESEARCH.md Pattern 2:
       - Query config.providers() for available models
       - Show only configured providers
       - Default to anthropic/claude-sonnet-4-20250514 if no preference
    
    5. Why flat list: Easier for UI dropdown than nested providers.
  </action>
  <verify>
    - opencode.ts exports getAvailableModels() returning flat model list
    - /models/available endpoint returns models from OpenCode
    - TypeScript compiles with OpenCode SDK types
  </verify>
  <done>
    Model API routes created, OpenCode wrapper extended with model listing and validation
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ModelSelector component</name>
  <files>
    apps/web/components/model/model-selector.tsx
    apps/web/package.json
  </files>
  <action>
    1. Install UI component if needed:
       - `npx shadcn add select` for dropdown (if not exists)
    
    2. Create apps/web/components/model/model-selector.tsx:
       - Props: {
           value: string; // selected model ID
           onChange: (modelId: string) => void;
           disabled?: boolean; // while generating
           availableModels: Array<{ id, name, provider }>;
         }
       - Use Select component from shadcn/ui
       - Group by provider or show flat list with provider badges
       - Show model name + provider (e.g., "Claude Sonnet 4 - Anthropic")
       - Disable dropdown if `disabled` prop true
       - Loading state while fetching models
       - Search/filter if list is long (75+ models)
    
    3. Add ModelBadge component for compact display:
       - Shows just provider icon + model name
       - Used in session UI to show current model
    
    4. Pattern: Async fetch available models on mount, cache in component state.
    
    Why shadcn Select: Consistent with existing UI, accessible, searchable.
  </action>
  <verify>
    - ModelSelector renders with Select component
    - Shows model names and providers
    - Disabled state works
    - TypeScript compiles
  </verify>
  <done>
    ModelSelector component with Select dropdown, provider grouping, disabled state, model badges
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate model selection into settings and session creation</name>
  <files>
    apps/web/app/settings/page.tsx
    apps/web/components/session/create-session-dialog.tsx
    apps/web/components/session/session-panel.tsx
    apps/api/src/durable-objects/session.ts
  </files>
  <action>
    1. Update apps/web/app/settings/page.tsx:
       - Add "AI Model" section
       - Fetch available models on load (GET /api/models/available)
       - Show ModelSelector with user's current default
       - Save button to set default (POST /api/models/default)
       - Show selected model with provider icon
    
    2. Update apps/web/components/session/create-session-dialog.tsx:
       - Add ModelSelector below repo URL input
       - Label: "AI Model (optional)" 
       - Default: user's preference or "Use default"
       - Pass selected model to session creation API
       - Show "Default" option that uses global preference
    
    3. Update apps/web/components/session/session-panel.tsx:
       - Add current model display (ModelBadge) in panel header or status area
       - Show: "Using: Claude Sonnet 4"
       - If model override: show indicator (tooltip: "Override from default")
    
    4. Update apps/api/src/durable-objects/session.ts:
       - Add `model` column to store selected model
       - Add `setModel(model: string)` and `getModel()` methods
       - Use model when initializing OpenCode session
    
    5. Update session creation API to accept optional model parameter
    
    Pattern from CONTEXT.md:
    - Global preference in settings
    - Per-session override in creation dialog
    - Current model shown in session UI
  </action>
  <verify>
    - Settings page has model selection section
    - Create session dialog has model dropdown
    - Session panel shows current model
    - SessionDO stores model and uses it for OpenCode
    - TypeScript compiles
  </verify>
  <done>
    Model selection integrated: settings page (default), create dialog (override), session panel (display), SessionDO (storage)
  </done>
</task>

</tasks>

<verification>
1. /api/models/available returns models from OpenCode providers
2. ModelSelector component works in settings and create dialog
3. Default model saved to user preferences
4. Session creation accepts model override
5. Current model displayed in session panel
6. SessionDO stores and uses model for OpenCode sessions
</verification>

<success_criteria>

- User can select default model in settings page
- User can override model when creating a session
- Session panel shows currently selected model
- Model selection disabled while agent is generating
- Available models fetched dynamically from OpenCode API
  </success_criteria>

<output>
After completion, create `.planning/phases/03-execution-layer/03-05-SUMMARY.md`
</output>
