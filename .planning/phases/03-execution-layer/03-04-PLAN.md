---
phase: 03-execution-layer
plan: 04
type: execute
wave: 3
depends_on: ['03-02', '03-03']
files_modified:
  - apps/api/src/durable-objects/session.ts
  - apps/api/src/lib/agent-executor.ts
  - apps/web/components/git/pr-panel.tsx
  - apps/web/components/session/session-panel.tsx
autonomous: true

must_haves:
  truths:
    - 'Draft PR auto-created on first commit'
    - "PR uses user's GitHub token for attribution"
    - 'PR description includes task description'
    - 'PR number stored in session and displayed in UI'
    - 'User can mark PR ready for review from UI'
  artifacts:
    - path: 'apps/api/src/lib/agent-executor.ts'
      provides: 'Agent execution orchestrator with auto-PR'
      exports: ['AgentExecutor', 'executeTaskWithGitWorkflow']
    - path: 'apps/web/components/git/pr-panel.tsx'
      provides: 'PR status and controls in side panel'
      exports: ['PRPanel']
  key_links:
    - from: 'agent-executor.ts'
      to: 'git-workflow.ts'
      via: 'commit → check first commit → create PR'
      pattern: 'if.*firstCommit.*createPullRequest'
    - from: 'SessionDO'
      to: 'SQLite storage'
      via: 'prNumber storage'
      pattern: 'pr_number.*storage'
---

<objective>
Integrate Git workflow into agent execution. On first commit, automatically create a draft PR using user's GitHub token. Store PR number in SessionDO for UI display. Add PR panel to session side panel showing PR status and "Mark Ready for Review" button. Per CONTEXT.md: auto-create draft PR at first commit, PRs opened as user.

Purpose: Complete the autonomous coding workflow - agent works in sandbox, commits changes, and delivers a draft PR for review.

Output: Agent executor with integrated Git workflow, PR panel component, SessionDO updates for PR tracking.
</objective>

<execution_context>
@/Users/dylansteck/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/dylansteck/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-execution-layer/03-CONTEXT.md
@.planning/phases/03-execution-layer/03-RESEARCH.md
@.planning/phases/03-execution-layer/03-01-SUMMARY.md
@.planning/phases/03-execution-layer/03-02-SUMMARY.md
@.planning/phases/03-execution-layer/03-03-SUMMARY.md

# Existing files

@apps/api/src/lib/git-workflow.ts
@apps/api/src/lib/github.ts
@apps/api/src/durable-objects/session.ts
@apps/web/components/session/session-panel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend SessionDO with PR tracking and git state</name>
  <files>
    apps/api/src/durable-objects/session.ts
  </files>
  <action>
    Extend SessionDO with Git workflow state tracking:
    
    1. Add to SQLite schema:
       - `pr_number` INTEGER (GitHub PR number)
       - `pr_url` TEXT (GitHub PR URL)
       - `pr_draft` BOOLEAN (is PR draft?)
       - `branch_name` TEXT (current git branch)
       - `first_commit_done` BOOLEAN (track if first commit happened)
       - `repo_url` TEXT (cloned repository URL)
    
    2. Add methods:
       - `setBranchName(name: string)` - Store branch name
       - `getBranchName()` - Get current branch
       - `markFirstCommit()` - Returns true if this was the first commit (for auto-PR)
       - `setPullRequest(number: number, url: string, draft: boolean)` - Store PR info
       - `getPullRequest()` - Get PR details
       - `markReadyForReview()` - Update PR from draft to ready
    
    3. Add RPC endpoints:
       - `/git/state` - GET current git state (branch, PR info)
       - `/git/pr/ready` - POST to mark PR ready for review
    
    4. Why track first commit: Per CONTEXT.md, auto-create draft PR on first commit. Need to know when first commit happens vs subsequent commits.
    
    Pattern: SessionDO is source of truth for session's git state and PR info.
  </action>
  <verify>
    - SessionDO schema updated with git/PR columns
    - New methods compile without type errors
    - RPC endpoints registered
  </verify>
  <done>
    SessionDO has git state tracking (branch, pr_number, first_commit_done) and methods to manage PR lifecycle
  </done>
</task>

<task type="auto">
  <name>Task 2: Create agent executor with integrated Git workflow</name>
  <files>
    apps/api/src/lib/agent-executor.ts
  </files>
  <action>
    Create apps/api/src/lib/agent-executor.ts to orchestrate agent + git:
    
    1. `AgentExecutor` class with:
       - Constructor: sessionDO, sandbox, opencodeClient, githubClient
       - Properties: isFirstCommit (boolean, initially true)
    
    2. `executeTask(taskDescription: string)` method:
       - Generate branch name using taskDescription + sessionId
       - Create branch in sandbox via GitWorkflow
       - Store branch name in SessionDO
       - Return execution context
    
    3. `onAgentResponse(response: AgentResponse)` method:
       - Called when agent completes a response/answer
       - Commit changes: `git add -A && git commit -m "{summary}"`
       - Push to remote
       - If first commit: Create draft PR via GitHubClient
       - Store PR info in SessionDO
       - Update firstCommit flag
    
    4. `commitChanges(message: string)` helper:
       - Get user's git config (name/email from GitHub token)
       - Use GitWorkflow.commitChanges()
       - Check SessionDO.markFirstCommit() to know if auto-PR needed
       - If first commit: Create PR with title = task description, body = automated message
    
    5. Error handling:
       - Wrap git operations in try/catch
       - Log errors but don't fail agent execution (continue trying)
       - Report git status to user via chat
    
    6. PR description template:
       ```
       Automated PR from Ship session
       
       Task: {taskDescription}
       Branch: {branchName}
       
       This PR was created automatically by the Ship agent.
       ```
    
    Pattern: AgentExecutor bridges OpenCode SDK events with Git workflow automation.
  </action>
  <verify>
    - AgentExecutor class has all required methods
    - Integrates with GitWorkflow and GitHubClient
    - firstCommit tracking logic correct
    - TypeScript compiles
  </verify>
  <done>
    AgentExecutor class created with executeTask(), onAgentResponse(), commitChanges() methods; auto-PR on first commit
  </done>
</task>

<task type="auto">
  <name>Task 3: Create PR panel component and integrate into session panel</name>
  <files>
    apps/web/components/git/pr-panel.tsx
    apps/web/components/session/session-panel.tsx
  </files>
  <action>
    1. Create apps/web/components/git/pr-panel.tsx:
       - Props: { prNumber?: number; prUrl?: string; isDraft?: boolean; onMarkReady?: () => void }
       - Show PR status card:
         - If no PR: "No pull request yet" with subtle hint
         - If PR exists: Show PR number, link to GitHub, draft status
         - If draft: Show "Mark Ready for Review" button
         - If ready: Show "View on GitHub" link
       - "Mark Ready for Review" button calls API: POST /api/sessions/:id/pr/ready
       - Open PR link in new tab
    
    2. Update apps/web/components/session/session-panel.tsx:
       - Add PRPanel to side panel (below tasks section)
       - Fetch PR data from SessionDO via API
       - Poll for PR updates (every 10 seconds)
       - Pass PR data to PRPanel
       - Handle "Mark Ready for Review" action with confirmation
    
    3. Styling:
       - Compact card design matching session panel
       - GitHub icon for PR link
       - Draft badge (yellow/orange)
       - Ready badge (green)
    
    4. Pattern from CONTEXT.md: User can mark ready for review via button or chat command. Start with button in side panel.
  </action>
  <verify>
    - PRPanel renders correctly with all states (no PR, draft, ready)
    - Mark Ready button calls API correctly
    - SessionPanel integrates PRPanel and polls for updates
    - TypeScript compiles
  </verify>
  <done>
    PRPanel component created, integrated into SessionPanel, polls for PR status, handles "Mark Ready" action
  </done>
</task>

</tasks>

<verification>
1. SessionDO tracks git state (branch, PR number, first commit flag)
2. AgentExecutor commits per agent response
3. Auto-PR created on first commit with draft status
4. PR uses user's GitHub token for attribution
5. PR panel shows PR status and "Mark Ready" button
6. PR number persists across page reloads (stored in SessionDO)
</verification>

<success_criteria>

- Draft PR auto-created on agent's first commit
- PR opened as user (user's GitHub token) with proper attribution
- PR description includes task description and branch info
- PR number stored in SessionDO and displayed in side panel
- User can click "Mark Ready for Review" to convert draft to ready PR
  </success_criteria>

<output>
After completion, create `.planning/phases/03-execution-layer/03-04-SUMMARY.md`
</output>
