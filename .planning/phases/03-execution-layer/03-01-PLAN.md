---
phase: 03-execution-layer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/lib/e2b.ts
  - apps/api/src/durable-objects/session.ts
  - apps/api/src/routes/sandbox.ts
  - apps/api/package.json
  - apps/api/src/routes/sessions.ts
  - apps/api/src/index.ts
autonomous: true

must_haves:
  truths:
    - 'Sandbox provisions automatically when session is created'
    - 'Sandbox ID persists in SessionDO and survives hibernation'
    - 'Auto-pause enabled to control costs'
    - 'Session can reconnect to existing sandbox on wake'
  artifacts:
    - path: 'apps/api/src/lib/e2b.ts'
      provides: 'E2B sandbox wrapper with create/resume/pause'
      exports: ['createSessionSandbox', 'resumeSandbox', 'SandboxManager']
    - path: 'apps/api/src/durable-objects/session.ts'
      provides: 'SessionDO with sandbox lifecycle methods'
      contains: ['sandboxId', 'provisionSandbox()', 'getSandbox()']
    - path: 'apps/api/src/routes/sandbox.ts'
      provides: 'Sandbox provisioning API'
      exports: ['POST /sandbox', 'GET /sandbox/:id/status']
  key_links:
    - from: 'apps/api/src/durable-objects/session.ts'
      to: 'apps/api/src/lib/e2b.ts'
      via: 'SandboxManager class'
      pattern: 'new SandboxManager'
    - from: 'SessionDO'
      to: 'SQLite storage'
      via: "this.ctx.storage.get('sandboxId')"
      pattern: 'sandboxId.*storage'

user_setup:
  - service: e2b
    why: 'Sandbox provisioning for isolated agent execution'
    env_vars:
      - name: E2B_API_KEY
        source: 'E2B Dashboard -> Settings -> API Keys'
---

<objective>
Integrate E2B sandbox provisioning into the session lifecycle. When a session is created, automatically provision an E2B sandbox with auto-pause enabled. Store the sandbox ID in SessionDO for persistence across hibernation. Implement lifecycle management (create, resume, pause) to control costs.

Purpose: This is the foundational infrastructure for Phase 3 - without sandbox provisioning, no agent execution can happen.

Output: E2B wrapper library, SessionDO updates for sandbox management, sandbox provisioning API.
</objective>

<execution_context>
@/Users/dylansteck/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/dylansteck/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-execution-layer/03-CONTEXT.md
@.planning/phases/03-execution-layer/03-RESEARCH.md

# Prior phase summary for patterns

@.planning/phases/02-stateful-core/02-06-SUMMARY.md

# Existing codebase files

@apps/api/src/durable-objects/session.ts
@apps/api/src/lib/opencode.ts
@apps/api/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install E2B SDK and create sandbox wrapper</name>
  <files>
    apps/api/package.json
    apps/api/src/lib/e2b.ts
  </files>
  <action>
    1. Install E2B SDK: `npm install @e2b/code-interpreter` in apps/api
    2. Create apps/api/src/lib/e2b.ts with:
       - `createSessionSandbox(sessionId: string)` - Creates sandbox with autoPause: true, 5-min timeout, metadata: { sessionId }
       - `resumeSandbox(sandboxId: string)` - Reconnects to existing sandbox
       - `SandboxManager` class to encapsulate lifecycle (create, resume, pause, getSandboxId)
       - Proper error handling for E2B API failures
    
    Use betaCreate() with autoPause: true per RESEARCH.md Pattern 1.
    Export sandboxId from the Sandbox instance for storage.
    
    Why this structure: SessionDO will own the sandbox lifecycle, but the wrapper abstracts E2B specifics.
  </action>
  <verify>
    - TypeScript compiles: `cd apps/api && npm run typecheck`
    - E2B types are importable: `import { Sandbox } from '@e2b/code-interpreter'`
  </verify>
  <done>
    E2B SDK installed, wrapper exports createSessionSandbox(), resumeSandbox(), and SandboxManager class with proper types
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend SessionDO with sandbox lifecycle</name>
  <files>
    apps/api/src/durable-objects/session.ts
  </files>
  <action>
    Extend SessionDO with sandbox lifecycle management:
    
    1. Add to SQLite schema (if using SQL storage) or storage methods:
       - `sandbox_id` TEXT column (stores E2B sandbox ID)
       - `sandbox_status` TEXT (active, paused, error)
    
    2. Add methods to SessionDO:
       - `provisionSandbox()` - Creates new sandbox, stores ID in storage, returns sandbox info
       - `getSandbox()` - Returns existing sandbox ID or null
       - `resumeSandbox()` - Reconnects to stored sandbox ID
       - `pauseSandbox()` - Calls betaPause() on sandbox (for idle timeout)
    
    3. Add RPC endpoints:
       - `/sandbox/provision` - POST to create new sandbox
       - `/sandbox/status` - GET current sandbox status
       - `/sandbox/pause` - POST to pause sandbox
    
    4. Auto-provision on session creation: Add to constructor or init flow - if no sandbox_id exists, provision one
    
    Pattern from RESEARCH.md: Store sandboxId for resumption after hibernation. Use autoPause to control costs.
    
    IMPORTANT: Sandbox lifecycle must be separate from DO hibernation - E2B auto-pause is independent.
  </action>
  <verify>
    - SessionDO compiles with new methods
    - RPC endpoints registered in fetch() handler
    - Unit test: Verify sandbox_id storage roundtrip (mock E2B if needed)
  </verify>
  <done>
    SessionDO has provisionSandbox(), getSandbox(), pauseSandbox() methods; RPC endpoints for /sandbox/*; sandbox_id stored in DO storage
  </done>
</task>

<task type="auto">
  <name>Task 3: Create sandbox API routes and integrate with sessions</name>
  <files>
    apps/api/src/routes/sandbox.ts
    apps/api/src/routes/sessions.ts
    apps/api/src/index.ts
  </files>
  <action>
    1. Create apps/api/src/routes/sandbox.ts:
       - `POST /sandbox` - Create new sandbox (returns sandboxId, status)
       - `GET /sandbox/:id/status` - Get sandbox status from E2B
       - `POST /sandbox/:id/pause` - Pause sandbox
       
    2. Update apps/api/src/routes/sessions.ts:
       - Modify POST /sessions to auto-provision sandbox using SessionDO.provisionSandbox()
       - Include sandboxId in session response
       - Add GET /sessions/:id/sandbox to get sandbox status
    
    3. Register sandbox routes in apps/api/src/index.ts
    
    4. Add environment validation: Check E2B_API_KEY on startup, log warning if missing
    
    Pattern: Session creation automatically provisions sandbox - user doesn't manually create sandbox.
    
    Why: Per CONTEXT.md, sandbox should provision automatically when user creates a session.
  </action>
  <verify>
    - API routes respond correctly: 
      - `POST /api/sandbox` returns { sandboxId, status }
      - `GET /api/sessions/:id/sandbox` returns sandbox info
    - Session creation includes sandbox provisioning (check response for sandboxId)
    - TypeScript compiles, no type errors
  </verify>
  <done>
    Sandbox API routes functional, session creation auto-provisions sandbox, E2B_API_KEY validated on startup
  </done>
</task>

</tasks>

<verification>
1. E2B SDK installed and types available
2. Sandbox wrapper exports createSessionSandbox() with autoPause
3. SessionDO stores sandbox_id and has lifecycle methods
4. Session creation automatically provisions sandbox
5. API endpoints for sandbox management exist
6. E2B_API_KEY environment variable documented
</verification>

<success_criteria>

- Creating a session automatically provisions an E2B sandbox (sandboxId returned)
- Sandbox ID persists in SessionDO and survives Durable Object hibernation
- API endpoints for sandbox status checking and pause work correctly
- Auto-pause enabled to control costs (5-min idle timeout)
  </success_criteria>

<output>
After completion, create `.planning/phases/03-execution-layer/03-01-SUMMARY.md`
</output>
