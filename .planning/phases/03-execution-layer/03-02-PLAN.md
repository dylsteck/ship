---
phase: 03-execution-layer
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - apps/web/components/sandbox/vscode-drawer.tsx
  - apps/web/components/sandbox/terminal-drawer.tsx
  - apps/web/components/sandbox/sandbox-toolbar.tsx
  - apps/web/app/(app)/session/[id]/page-client.tsx
  - apps/web/package.json
autonomous: false
user_setup: []

must_haves:
  truths:
    - "User can click VS Code button to open inline drawer"
    - "VS Code drawer shows code-server interface with repository files"
    - "User can click Terminal button to open inline drawer"
    - "Terminal shows live shell connected to sandbox"
    - "Drawers are non-blocking - user can continue chatting"
  artifacts:
    - path: "apps/web/components/sandbox/vscode-drawer.tsx"
      provides: "Inline VS Code drawer with code-server iframe"
      exports: ["VSCodeDrawer"]
    - path: "apps/web/components/sandbox/terminal-drawer.tsx"
      provides: "Inline terminal drawer with xterm.js"
      exports: ["TerminalDrawer"]
    - path: "apps/web/components/sandbox/sandbox-toolbar.tsx"
      provides: "Toolbar with VS Code and Terminal buttons"
      exports: ["SandboxToolbar"]
  key_links:
    - from: "vscode-drawer.tsx"
      to: "E2B sandbox"
      via: "iframe src with sandboxId"
      pattern: "https://.*\.e2b\.dev:8080"
    - from: "terminal-drawer.tsx"
      to: "E2B commands API"
      via: "WebSocket or command streaming"
      pattern: "sandbox\.commands\.run"
---

<objective>
Build the sandbox access UI: inline drawers for VS Code (via code-server iframe) and Terminal (via xterm.js). Add a toolbar with access buttons to the session page. Drawers open inline (slide-out) per CONTEXT.md decisions - not modal or new tab. Background execution pattern: user can check in when they want.

Purpose: Provide user visibility into the sandbox where agent is working - non-blocking UI that doesn't interrupt chat flow.

Output: VSCodeDrawer, TerminalDrawer, SandboxToolbar components integrated into session page.
</objective>

<execution_context>
@/Users/dylansteck/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/dylansteck/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-execution-layer/03-CONTEXT.md
@.planning/phases/03-execution-layer/03-RESEARCH.md
@.planning/phases/03-execution-layer/03-01-SUMMARY.md

# Prior phase for UI patterns

@.planning/phases/02-stateful-core/02-07-SUMMARY.md

# Existing session page

@apps/web/app/(app)/session/[id]/page-client.tsx
@apps/web/components/session/session-panel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install terminal dependencies and create VS Code drawer</name>
  <files>
    apps/web/package.json
    apps/web/components/sandbox/vscode-drawer.tsx
  </files>
  <action>
    1. Install xterm.js dependencies:
       - `npm install @xterm/xterm xterm-addon-fit xterm-addon-web-links` in apps/web
       - Add CSS import: `import '@xterm/xterm/css/xterm.css'`
    
    2. Create apps/web/components/sandbox/vscode-drawer.tsx:
       - Props: { sandboxId: string; isOpen: boolean; onOpenChange: (open: boolean) => void }
       - Use shadcn/ui Sheet component (direction="right") for inline drawer
       - Embed code-server in iframe: `https://${sandboxId}.e2b.dev:8080`
       - Add iframe attributes: sandbox="allow-scripts allow-same-origin allow-forms allow-popups" allow="clipboard-read; clipboard-write"
       - Show loading state while iframe loads
       - Handle errors (sandbox not ready, code-server not started)
    
    3. Pattern from RESEARCH.md: code-server runs on port 8080 in sandbox with --auth none for iframe embedding.
    
    IMPORTANT: CSP headers must allow iframe embedding. E2B handles this, but verify with test.
  </action>
  <verify>
    - VSCodeDrawer component renders without errors
    - Sheet component from shadcn/ui works (run `npx shadcn add sheet` if needed)
    - TypeScript compiles with xterm.js types
  </verify>
  <done>
    VSCodeDrawer component created with iframe embedding code-server, Sheet for slide-out drawer, proper CSP attributes
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Terminal drawer with xterm.js</name>
  <files>
    apps/web/components/sandbox/terminal-drawer.tsx
  </files>
  <action>
    Create apps/web/components/sandbox/terminal-drawer.tsx:
    
    1. Props: { sandboxId: string; isOpen: boolean; onOpenChange: (open: boolean) => void }
    
    2. Use xterm.js Terminal with:
       - cursorBlink: true
       - fontSize: 14
       - fontFamily: 'JetBrains Mono, monospace' (or system mono)
       - Theme matching app dark/light mode
    
    3. Load FitAddon for responsive sizing
    
    4. Terminal connection strategy (per RESEARCH.md Open Questions):
       - MVP: Use E2B commands.run() with streaming output
       - Display output in terminal (read-only initially)
       - Future: Full shell via WebSocket if needed
    
    5. Use Sheet component with direction="bottom" for terminal (standard terminal position)
    
    6. Handle resize: Call fitAddon.fit() on window resize
    
    7. Show connection status (connecting, connected, error)
    
    Why read-only initially: Full shell WebSocket is complex. Start with command output streaming via E2B API.
  </action>
  <verify>
    - TerminalDrawer component renders xterm.js terminal
    - Terminal fits container (FitAddon working)
    - TypeScript compiles, no xterm.js type errors
  </verify>
  <done>
    TerminalDrawer with xterm.js, FitAddon, bottom Sheet, displays command output from E2B sandbox
  </done>
</task>

<task type="auto">
  <name>Task 3: Create sandbox toolbar and integrate into session page</name>
  <files>
    apps/web/components/sandbox/sandbox-toolbar.tsx
    apps/web/app/(app)/session/[id]/page-client.tsx
  </files>
  <action>
    1. Create apps/web/components/sandbox/sandbox-toolbar.tsx:
       - Props: { sandboxId: string | null; sandboxStatus: string }
       - Small icon buttons in top-right (per CONTEXT.md Ramp Inspect style):
         - VS Code button (Code icon) - opens VSCodeDrawer
         - Terminal button (Terminal icon) - opens TerminalDrawer
       - Show disabled state if no sandbox (sandboxId is null)
       - Show loading indicator while sandbox provisioning
       - Tooltips on hover: "Open VS Code", "Open Terminal"
    
    2. Update apps/web/app/(app)/session/[id]/page-client.tsx:
       - Fetch sandbox status from API (GET /api/sessions/:id/sandbox)
       - Add state: vscodeOpen, terminalOpen, sandboxId, sandboxStatus
       - Integrate SandboxToolbar in header area (near status indicator)
       - Add VSCodeDrawer and TerminalDrawer components
       - Pass sandboxId to drawers when open
    
    3. Style: Compact toolbar, icons only (16px), subtle hover states
    
    4. Pattern from CONTEXT.md: "Small icons in top-right for terminal and preview"
    
    Why this location: Consistent with Ramp Inspect UI pattern, non-blocking to chat.
  </action>
  <verify>
    - SandboxToolbar renders with VS Code and Terminal buttons
    - Clicking buttons opens respective drawers
    - Drawers display in correct positions (VS Code: right slide, Terminal: bottom slide)
    - Session page fetches sandbox data and passes to components
    - TypeScript compiles, no errors
  </verify>
  <done>
    SandboxToolbar integrated into session page, VSCodeDrawer and TerminalDrawer functional, sandbox data flows from API to UI
  </done>
</task>

<task type="checkpoint:human-verify">
  <what-built>
    VS Code and Terminal access UI for sandbox
    - Sandbox toolbar with VS Code and Terminal buttons (top-right of session page)
    - VS Code drawer: slide-out from right with code-server iframe
    - Terminal drawer: slide-up from bottom with xterm.js terminal
    - Both drawers are non-blocking (user can continue chatting)
  </what-built>
  <how-to-verify>
    1. Create a new session (triggers sandbox provisioning)
    2. Wait 10-20 seconds for E2B sandbox to provision and code-server to start
    3. Click VS Code button in toolbar (top-right)
    4. Verify: Drawer opens from right, shows VS Code interface loading
    5. If code-server ready: See file explorer with repository
    6. Click Terminal button in toolbar
    7. Verify: Drawer opens from bottom, shows terminal with prompt
    8. Type a command in terminal (if interactive) or verify output displays
    9. Close drawers and verify chat still works normally
  </how-to-verify>
  <resume-signal>
    Type "approved" if VS Code and Terminal drawers work correctly, or describe any issues (iframe not loading, terminal not connecting, styling problems)
  </resume-signal>
</task>

</tasks>

<verification>
1. VS Code drawer opens inline (slide from right) with code-server iframe
2. Terminal drawer opens inline (slide from bottom) with xterm.js
3. Toolbar buttons visible in session page header
4. Drawers non-blocking - chat still usable
5. Sandbox status shown (loading, ready, error)
</verification>

<success_criteria>

- User can click VS Code button to open inline drawer showing repository files
- User can click Terminal button to open inline drawer with working terminal
- Drawers don't block chat interface (background execution pattern)
- Sandbox toolbar shows provisioning status
  </success_criteria>

<output>
After completion, create `.planning/phases/03-execution-layer/03-02-SUMMARY.md`
</output>
