---
phase: 03-execution-layer
plan: 07
type: execute
wave: 4
depends_on: ["03-02", "03-04", "03-05", "03-06"]
files_modified:
  - apps/api/src/durable-objects/session.ts
  - apps/api/src/lib/agent-executor.ts
  - apps/api/src/routes/chat.ts
  - apps/web/app/(app)/session/[id]/page-client.tsx
  - apps/web/components/chat/chat-interface.tsx
autonomous: false

must_haves:
  truths:
    - "End-to-end flow works: session → sandbox → agent → git → PR"
    - "Agent commits appear in GitHub"
    - "PR created automatically on first commit"
    - "Error recovery works in practice"
    - "User can monitor and intervene if needed"
  artifacts:
    - path: "apps/api/src/lib/agent-executor.ts"
      provides: "Complete agent execution with all integrations"
      contains: ["executeTask", "onAgentResponse", "errorHandling"]
    - path: "apps/web/app/(app)/session/[id]/page-client.tsx"
      provides: "Integrated session page with all features"
      contains: ["sandbox toolbar", "chat", "side panel"]
  key_links:
    - from: "ChatInterface"
      to: "AgentExecutor"
      via: "OpenCode SDK streaming"
      pattern: "opencode.*session.*prompt"
    - from: "AgentExecutor"
      to: "GitWorkflow"
      via: "commit on agent response"
      pattern: "commitChanges.*onAgentResponse"
    - from: "AgentExecutor"
      to: "SessionDO"
      via: "store PR number, branch"
      pattern: "sessionDO\.setPullRequest"
---

<objective>
Integrate all Phase 3 components into complete end-to-end flow. Connect agent execution to Git workflow: on agent response, commit changes and push. Auto-create draft PR on first commit. Wire error handling into chat. Add final verification checkpoint. This is the "glue" plan that makes all pieces work together.

Purpose: Deliver working autonomous agent execution - user creates session, agent works in sandbox, commits appear on GitHub, PR created automatically.

Output: Integrated agent executor, complete session page, end-to-end workflow verified.
</objective>

<execution_context>
@/Users/dylansteck/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/dylansteck/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-execution-layer/03-CONTEXT.md
@.planning/phases/03-execution-layer/03-RESEARCH.md
@.planning/phases/03-execution-layer/03-01-SUMMARY.md
@.planning/phases/03-execution-layer/03-02-SUMMARY.md
@.planning/phases/03-execution-layer/03-03-SUMMARY.md
@.planning/phases/03-execution-layer/03-04-SUMMARY.md
@.planning/phases/03-execution-layer/03-05-SUMMARY.md
@.planning/phases/03-execution-layer/03-06-SUMMARY.md

# All key files from previous plans

@apps/api/src/lib/agent-executor.ts
@apps/api/src/lib/git-workflow.ts
@apps/api/src/lib/github.ts
@apps/api/src/lib/e2b.ts
@apps/api/src/lib/error-handler.ts
@apps/api/src/durable-objects/session.ts
@apps/api/src/routes/chat.ts
@apps/web/app/(app)/session/[id]/page-client.tsx
@apps/web/components/chat/chat-interface.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire agent execution to Git workflow in SessionDO</name>
  <files>
    apps/api/src/durable-objects/session.ts
    apps/api/src/lib/agent-executor.ts
  </files>
  <action>
    1. Update apps/api/src/durable-objects/session.ts:
       - Add `initializeAgentExecutor()` method:
         - Creates AgentExecutor instance
         - Passes: sessionId, sandbox, opencodeClient, githubClient, sessionDO
         - Binds to OpenCode event stream
       - Add `handleAgentResponse(response)` method:
         - Called on each agent response/answer
         - Triggers: git commit, push, auto-PR if first commit
         - Emits status updates to WebSocket
       - Add `startTask(taskDescription)` method:
         - Generates branch name
         - Clones repo if not cloned
         - Creates branch
         - Starts agent with task
       - Add RPC endpoints:
         - `/task/start` - POST to start new task
         - `/agent/event` - WebSocket for agent events
    
    2. Update apps/api/src/lib/agent-executor.ts:
       - Ensure all dependencies wired: GitWorkflow, GitHubClient, ErrorHandler
       - Add `bindToSession(sessionDO)` method for bidirectional communication
       - Add `emitStatus(status, details)` to send updates to SessionDO
    
    3. Why SessionDO owns orchestration: It's the durable state holder. AgentExecutor is the logic wrapper.
    
    Pattern: SessionDO calls AgentExecutor methods, AgentExecutor emits events back to SessionDO for broadcast.
  </action>
  <verify>
    - SessionDO has initializeAgentExecutor(), handleAgentResponse(), startTask() methods
    - AgentExecutor has bindToSession() and emitStatus() methods
    - All dependencies (GitWorkflow, GitHubClient, ErrorHandler) wired
    - TypeScript compiles
  </verify>
  <done>
    SessionDO orchestrates agent execution with Git workflow integration, AgentExecutor properly bound
  </done>
</task>

<task type="auto">
  <name>Task 2: Update chat route with complete execution flow</name>
  <files>
    apps/api/src/routes/chat.ts
  </files>
  <action>
    Update apps/api/src/routes/chat.ts with full execution flow:
    
    1. On chat message received:
       - Parse message for task intent (e.g., "fix the auth bug")
       - If task detected: Call sessionDO.startTask(taskDescription)
       - Else: Normal chat response
    
    2. During agent streaming:
       - Existing: Stream content to SSE
       - New: Track when agent completes a response (message.part.done)
       - On completion: Trigger git commit via sessionDO.handleAgentResponse()
    
    3. Error handling integration:
       - Wrap agent operations in executeWithRetry
       - On error: Emit error message to SSE with category
       - Client displays error in chat with actions
    
    4. Model selection:
       - Get model from sessionDO (user's choice)
       - Pass to OpenCode session
       - Validate model is available before starting
    
    5. PR tracking:
       - After PR creation: Include PR URL in SSE stream
       - Client shows "Created draft PR #123" message
    
    6. Add endpoints:
       - `POST /chat/:sessionId/task` - Explicit task start
       - `POST /chat/:sessionId/retry` - Retry failed operation
       - `POST /chat/:sessionId/pause` - Pause agent (user action)
       - `POST /chat/:sessionId/resume` - Resume agent
    
    Pattern: Chat route is the entry point, delegates orchestration to SessionDO.
  </action>
  <verify>
    - Chat route integrates with SessionDO agent execution
    - Git commits triggered on agent responses
    - Error handling with retry integrated
    - Model selection passed to OpenCode
    - New endpoints registered
    - TypeScript compiles
  </verify>
  <done>
    Chat route fully integrated: task detection, git workflow, error handling, model selection, PR tracking
  </done>
</task>

<task type="auto">
  <name>Task 3: Update session page with complete integration</name>
  <files>
    apps/web/app/(app)/session/[id]/page-client.tsx
    apps/web/components/chat/chat-interface.tsx
  </files>
  <action>
    1. Update apps/web/app/(app)/session/[id]/page-client.tsx:
       - Ensure all components integrated:
         - ChatInterface with error handling
         - SessionPanel with PR panel
         - SandboxToolbar with VS Code/Terminal drawers
         - StatusIndicator showing agent state
       - Add error handling props:
         - `onRetryOperation` - Call API to retry
         - `onOpenVSCode` - Open VS Code drawer
         - `onOpenTerminal` - Open Terminal drawer
       - Add model display in header
       - Ensure WebSocket reconnects on disconnect
    
    2. Update apps/web/components/chat/chat-interface.tsx:
       - Handle error-type messages
       - Show ErrorMessage component with actions
       - Implement retry callback: POST /api/chat/:sessionId/retry
       - Track agent state (generating/paused/error) for model selection disable
       - Show PR creation notification when PR created
    
    3. Add loading states:
       - Sandbox provisioning: Show spinner in toolbar
       - Agent starting: Show "Initializing..." in chat
       - Git operations: Show "Committing changes..." briefly
    
    4. Polish:
       - Ensure all drawers work (VS Code, Terminal)
       - Ensure PR panel updates when PR created
       - Ensure status indicator reflects agent state
    
    Pattern: All Phase 3 features visible and functional on session page.
  </action>
  <verify>
    - Session page has all components integrated
    - Chat handles error messages with retry/actions
    - Drawers open correctly
    - PR panel shows PR when created
    - TypeScript compiles
  </verify>
  <done>
    Session page fully integrated with all Phase 3 features: sandbox, git, PR, errors, model selection
  </done>
</task>

<task type="checkpoint:human-verify">
  <what-built>
    Complete Phase 3: Execution Layer - End-to-end agent execution with Git workflow
    
    Features integrated:
    - Automatic E2B sandbox provisioning on session creation
    - VS Code and Terminal access via inline drawers
    - Agent execution with automatic git commits per response
    - Automatic draft PR creation on first commit
    - Model selection (global preference + per-session override)
    - Error handling with auto-retry and user notification
    - PR panel with "Mark Ready for Review" button
    - Complete session page with all components
  </what-built>
  <how-to-verify>
    Complete end-to-end test:
    
    1. Set default model in Settings page (e.g., Claude Sonnet 4)
    2. Create new session with repo URL (your test repo)
       - Verify: Sandbox provisions (see sandboxId in response)
       - Verify: Model shows in session (with override if selected)
    3. Send message: "Add a README file to this repository"
       - Verify: Agent starts working (status shows "Coding")
       - Verify: VS Code drawer opens and shows files
       - Verify: Terminal drawer opens and shows commands
    4. Wait for agent to complete
       - Verify: "Committing changes..." appears briefly
       - Verify: Git commit appears (check git log via terminal)
    5. Check GitHub
       - Verify: Branch pushed (ship-{slug}-{timestamp})
       - Verify: Draft PR created with description
       - Verify: PR attributed to your GitHub account
    6. Return to Ship
       - Verify: PR panel shows PR number and "Mark Ready for Review"
       - Verify: Side panel shows branch name
    7. Click "Mark Ready for Review"
       - Verify: PR converts from draft to ready on GitHub
    8. Test error handling:
       - Disconnect internet briefly during task
       - Verify: Error appears in chat with "Retry" button
       - Click Retry
       - Verify: Agent resumes and completes
    9. Verify background execution:
       - Start a task
       - Navigate to another tab
       - Return after 2 minutes
       - Verify: Task completed, results visible
    
    All Phase 3 success criteria:
    ✓ System provisions E2B sandbox when user creates session
    ✓ User can access VS Code and terminal
    ✓ Agent clones repo, creates branch, makes changes, commits, pushes
    ✓ Agent creates GitHub pull request
    ✓ Agent handles errors and recovers
    ✓ User can select AI model
  </how-to-verify>
  <resume-signal>
    Type "approved" if all end-to-end tests pass and Phase 3 is complete. Describe any issues encountered.
  </resume-signal>
</task>

</tasks>

<verification>
1. SessionDO orchestrates complete agent + git workflow
2. Chat route integrates all execution pieces
3. Session page shows all components working together
4. End-to-end flow tested: session → sandbox → agent → git → PR
5. Error recovery works in practice
6. All Phase 3 success criteria met
</verification>

<success_criteria>

- Complete end-to-end flow works: Create session → sandbox provisions → agent works → commits → PR created
- Agent commits appear on GitHub with proper attribution
- Draft PR auto-created on first commit
- Error recovery tested and working
- User can monitor via VS Code/Terminal drawers
- Model selection functional
- All Phase 3 requirements satisfied
  </success_criteria>

<output>
After completion, create `.planning/phases/03-execution-layer/03-07-SUMMARY.md`
</output>
