---
phase: 02-stateful-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/durable-objects/session.ts
  - apps/api/src/env.d.ts
  - apps/api/wrangler.toml
  - apps/api/src/index.ts
autonomous: true

must_haves:
  truths:
    - "SessionDO class exists and can be instantiated"
    - "SQLite schema initializes on DO construction"
    - "DO binding is available in Worker environment"
  artifacts:
    - path: "apps/api/src/durable-objects/session.ts"
      provides: "SessionDO class with SQLite storage"
      exports: ["SessionDO"]
      min_lines: 80
    - path: "apps/api/src/env.d.ts"
      provides: "TypeScript types for DO binding"
      contains: "SESSION_DO"
    - path: "apps/api/wrangler.toml"
      provides: "DO namespace configuration"
      contains: "durable_objects"
  key_links:
    - from: "apps/api/wrangler.toml"
      to: "SessionDO class"
      via: "durable_objects binding"
      pattern: "class_name.*SessionDO"
    - from: "apps/api/src/index.ts"
      to: "apps/api/src/durable-objects/session.ts"
      via: "export for DO binding"
      pattern: "export.*SessionDO"
---

<objective>
Create the Durable Object infrastructure for session state management.

Purpose: This establishes the foundation for all session state in the application. The SessionDO class with SQLite storage will persist conversations, tasks, and metadata. Every subsequent plan depends on this infrastructure.

Output: A fully configured SessionDO class with SQLite schema, proper Cloudflare bindings, and TypeScript types.
</objective>

<execution_context>
@/Users/dylansteck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dylansteck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-stateful-core/02-RESEARCH.md

# Existing files to modify
@apps/api/src/index.ts
@apps/api/src/env.d.ts
@apps/api/wrangler.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SessionDO class with SQLite schema</name>
  <files>apps/api/src/durable-objects/session.ts</files>
  <action>
Create the SessionDO Durable Object class following Cloudflare patterns from research.

The class should:
1. Extend DurableObject from 'cloudflare:workers'
2. Initialize SQLite storage in constructor via ctx.storage.sql
3. Use blockConcurrencyWhile for schema initialization
4. Create tables for: messages, tasks, session_meta
5. Include indexes for message ordering and task status

SQLite schema (from 02-RESEARCH.md):
```sql
CREATE TABLE IF NOT EXISTS messages (
  id TEXT PRIMARY KEY,
  role TEXT NOT NULL,
  content TEXT NOT NULL,
  parts TEXT, -- JSON for tool parts
  created_at INTEGER NOT NULL
);
CREATE TABLE IF NOT EXISTS tasks (
  id TEXT PRIMARY KEY,
  title TEXT NOT NULL,
  description TEXT,
  status TEXT DEFAULT 'pending',
  mode TEXT DEFAULT 'build',
  created_at INTEGER NOT NULL,
  completed_at INTEGER
);
CREATE TABLE IF NOT EXISTS session_meta (
  key TEXT PRIMARY KEY,
  value TEXT
);
CREATE INDEX IF NOT EXISTS idx_messages_created ON messages(created_at);
CREATE INDEX IF NOT EXISTS idx_tasks_status ON tasks(status, created_at);
```

Add basic RPC methods that will be expanded in later plans:
- getSessionMeta(): Returns session metadata as key-value object
- setSessionMeta(key, value): Sets a metadata value
- getRecentMessages(limit): Returns last N messages

Do NOT add WebSocket handling yet - that's Plan 02-03.
Do NOT add message persistence yet - that's Plan 02-04.

Use TypeScript with proper types. The Env interface will be defined in env.d.ts.
  </action>
  <verify>
Run `pnpm -F api build` - should compile without errors.
Check that the file exports SessionDO class.
  </verify>
  <done>SessionDO class exists with SQLite schema initialization and basic RPC methods.</done>
</task>

<task type="auto">
  <name>Task 2: Configure Durable Object bindings</name>
  <files>apps/api/wrangler.toml, apps/api/src/env.d.ts</files>
  <action>
Update wrangler.toml to add Durable Object configuration:

1. Add durable_objects section:
```toml
[durable_objects]
bindings = [
  { name = "SESSION_DO", class_name = "SessionDO" }
]

[[migrations]]
tag = "v1"
new_sqlite_classes = ["SessionDO"]
```

2. Update env.d.ts to add the DO binding type:
```typescript
import type { SessionDO } from './durable-objects/session';

export interface Env {
  // Existing bindings...
  DB: D1Database;
  ENVIRONMENT: string;
  ANTHROPIC_API_KEY: string;
  API_SECRET: string;

  // Durable Objects
  SESSION_DO: DurableObjectNamespace<SessionDO>;
}
```

3. Add the same DO config to env.production and env.staging in wrangler.toml.

IMPORTANT: Use new_sqlite_classes in migrations (not new_classes) for SQLite backend.
  </action>
  <verify>
Run `pnpm -F api typecheck` - should pass with no errors about SESSION_DO.
Verify wrangler.toml has durable_objects section.
  </verify>
  <done>Wrangler configured with SESSION_DO binding, env.d.ts has proper types.</done>
</task>

<task type="auto">
  <name>Task 3: Export SessionDO from worker entry point</name>
  <files>apps/api/src/index.ts</files>
  <action>
Update index.ts to export the SessionDO class so Cloudflare can instantiate it.

Add at the bottom of the file (after the default export):
```typescript
// Export Durable Objects for Cloudflare binding
export { SessionDO } from './durable-objects/session';
```

This is required by Cloudflare - the DO class must be exported from the entry point.

Do NOT modify the Hono app routes yet - that's Plan 02-02.
  </action>
  <verify>
Run `pnpm -F api build` - should compile and include SessionDO in output.
Run `wrangler dev --local` in apps/api - should start without DO binding errors.
  </verify>
  <done>SessionDO exported from worker entry point, ready for Cloudflare instantiation.</done>
</task>

</tasks>

<verification>
1. `pnpm -F api build` passes
2. `pnpm -F api typecheck` passes
3. `wrangler dev --local` starts (in apps/api directory)
4. SessionDO class file exists at apps/api/src/durable-objects/session.ts
5. Wrangler.toml contains durable_objects binding
</verification>

<success_criteria>
- SessionDO class exists with SQLite schema for messages, tasks, session_meta tables
- TypeScript compiles without errors
- Wrangler recognizes the DO binding
- Foundation ready for session routes (Plan 02-02) and WebSocket (Plan 02-03)
</success_criteria>

<output>
After completion, create `.planning/phases/02-stateful-core/02-01-SUMMARY.md`
</output>
