---
phase: 02-stateful-core
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - apps/api/src/routes/sessions.ts
  - apps/api/src/index.ts
  - apps/web/components/session/session-list.tsx
  - apps/web/components/session/create-session-dialog.tsx
  - apps/web/app/(app)/dashboard/page.tsx
  - apps/web/lib/api.ts
autonomous: true

must_haves:
  truths:
    - "User can create a new session via UI"
    - "User can see list of their sessions"
    - "User can delete a session"
    - "Sessions display repo name and last activity"
  artifacts:
    - path: "apps/api/src/routes/sessions.ts"
      provides: "Session CRUD endpoints"
      exports: ["default"]
      min_lines: 60
    - path: "apps/web/components/session/session-list.tsx"
      provides: "Session list component"
      exports: ["SessionList"]
      min_lines: 40
    - path: "apps/web/components/session/create-session-dialog.tsx"
      provides: "Session creation dialog"
      exports: ["CreateSessionDialog"]
      min_lines: 30
  key_links:
    - from: "apps/web/components/session/session-list.tsx"
      to: "/api/sessions"
      via: "fetch for session data"
      pattern: "fetch.*sessions"
    - from: "apps/api/src/routes/sessions.ts"
      to: "SESSION_DO"
      via: "DO stub creation"
      pattern: "SESSION_DO\\.idFromName"
---

<objective>
Implement session CRUD operations with API endpoints and session list UI.

Purpose: Users need to create and manage sessions before they can chat. This delivers SESS-01 (User can create, view, delete sessions) and enables the dashboard to show session list instead of placeholder content.

Output: Working session management - users can create sessions tied to repos, see their sessions, and delete sessions.
</objective>

<execution_context>
@/Users/dylansteck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dylansteck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-stateful-core/02-CONTEXT.md
@.planning/phases/02-stateful-core/02-01-SUMMARY.md

# Existing files
@apps/api/src/index.ts
@apps/api/src/durable-objects/session.ts
@apps/web/app/(app)/dashboard/page.tsx
@apps/web/lib/dal.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create session API routes</name>
  <files>apps/api/src/routes/sessions.ts, apps/api/src/index.ts</files>
  <action>
Create session CRUD endpoints following existing route patterns (see routes/users.ts).

Endpoints:
1. GET /sessions - List user's sessions
   - Accept userId from query param (auth validation in Phase 3)
   - Return array of session objects with id, repoName, repoOwner, status, lastActivity, createdAt
   - For now, store session list in D1 (not DO) since we need cross-session queries

2. POST /sessions - Create new session
   - Body: { userId, repoOwner, repoName }
   - Generate UUID for session ID
   - Create DO instance and initialize metadata
   - Store session record in D1
   - Return session object

3. GET /sessions/:id - Get single session
   - Fetch from D1, include message count from DO

4. DELETE /sessions/:id - Delete session
   - Delete from D1 and DO
   - DO deletion via stub.delete() (will clean up on DO side)

Add to index.ts:
```typescript
import sessions from './routes/sessions'
app.route('/sessions', sessions)
```

D1 schema for sessions table (add to existing migration):
```sql
CREATE TABLE IF NOT EXISTS sessions (
  id TEXT PRIMARY KEY,
  user_id TEXT NOT NULL,
  repo_owner TEXT NOT NULL,
  repo_name TEXT NOT NULL,
  status TEXT DEFAULT 'active',
  last_activity INTEGER NOT NULL,
  created_at INTEGER NOT NULL,
  archived_at INTEGER
);
CREATE INDEX IF NOT EXISTS idx_sessions_user ON sessions(user_id, status);
```

Run migration after creating: `wrangler d1 execute ship-db --local --command "..."`
  </action>
  <verify>
Run `pnpm -F api build` - compiles without errors.
Test with curl:
- `curl http://localhost:8787/sessions?userId=test` returns []
- `curl -X POST http://localhost:8787/sessions -d '{"userId":"test","repoOwner":"owner","repoName":"repo"}' -H "Content-Type: application/json"` returns session object
  </verify>
  <done>Session CRUD API endpoints working with D1 storage and DO integration.</done>
</task>

<task type="auto">
  <name>Task 2: Create session list and create dialog components</name>
  <files>apps/web/components/session/session-list.tsx, apps/web/components/session/create-session-dialog.tsx, apps/web/lib/api.ts</files>
  <action>
Create the session list component and create session dialog.

1. Create apps/web/lib/api.ts - API client helper:
```typescript
const API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8787';

export async function fetchSessions(userId: string) {
  const res = await fetch(`${API_URL}/sessions?userId=${userId}`);
  if (!res.ok) throw new Error('Failed to fetch sessions');
  return res.json();
}

export async function createSession(data: { userId: string; repoOwner: string; repoName: string }) {
  const res = await fetch(`${API_URL}/sessions`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data),
  });
  if (!res.ok) throw new Error('Failed to create session');
  return res.json();
}

export async function deleteSession(id: string) {
  const res = await fetch(`${API_URL}/sessions/${id}`, { method: 'DELETE' });
  if (!res.ok) throw new Error('Failed to delete session');
}
```

2. Create SessionList component (apps/web/components/session/session-list.tsx):
- Display sessions as cards/list items
- Show repo name (owner/repo), status indicator, last activity relative time
- Link each session to /session/[id]
- Include delete button with confirmation
- Show empty state when no sessions
- Use existing Tailwind patterns from the app

3. Create CreateSessionDialog component:
- Dialog/modal for creating new session
- For now, simple inputs for repoOwner and repoName (repo selector in Phase 3 when GitHub repos available)
- Submit calls createSession API
- Close and refresh list on success
- Show error toast on failure (use sonner if available, else alert)

IMPORTANT from CONTEXT.md:
- "User selects repo from connected repos when creating session (no paste URL option)"
- For Phase 2, we'll use simple inputs since GitHub repos API isn't ready
- Leave TODO comment for Phase 3 repo selector
  </action>
  <verify>
Run `pnpm -F web build` - compiles without errors.
Components exist and export correctly.
  </verify>
  <done>SessionList and CreateSessionDialog components created with proper styling.</done>
</task>

<task type="auto">
  <name>Task 3: Update dashboard to show session list</name>
  <files>apps/web/app/(app)/dashboard/page.tsx</files>
  <action>
Update the dashboard page to show the session list instead of placeholder content.

The dashboard should:
1. Import and use verifySession() from lib/dal for auth
2. Fetch sessions for the current user
3. Render SessionList component
4. Include "New Session" button that opens CreateSessionDialog
5. Handle loading and error states

Structure:
```tsx
import { verifySession } from '@/lib/dal';
import { SessionList } from '@/components/session/session-list';
import { CreateSessionDialog } from '@/components/session/create-session-dialog';

export default async function DashboardPage() {
  const session = await verifySession();
  // ...
}
```

The dashboard is the "main view" per CONTEXT.md decision: "Session list is the main dashboard view"

Add proper layout:
- Header with "Sessions" title and "New Session" button
- Session list below
- Responsive design (cards on mobile, table on desktop optional)
  </action>
  <verify>
Run `pnpm -F web dev` and visit http://localhost:3000/dashboard.
Dashboard shows session list (empty initially).
Can click "New Session" and dialog appears.
  </verify>
  <done>Dashboard displays session list with create session functionality.</done>
</task>

</tasks>

<verification>
1. `pnpm -F api build` and `pnpm -F web build` both pass
2. API endpoints respond correctly:
   - GET /sessions returns session array
   - POST /sessions creates session and returns it
   - DELETE /sessions/:id removes session
3. Dashboard shows session list
4. Can create new session via dialog
5. New session appears in list after creation
</verification>

<success_criteria>
- User can create a new session and it appears in session list (Success Criteria #1)
- User can view their sessions on dashboard
- User can delete sessions
- Sessions are persisted in D1 with DO reference
</success_criteria>

<output>
After completion, create `.planning/phases/02-stateful-core/02-02-SUMMARY.md`
</output>
