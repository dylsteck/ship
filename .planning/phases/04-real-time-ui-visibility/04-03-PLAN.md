---
phase: 04-real-time-ui-visibility
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/lib/cost-tracker.ts
  - apps/web/components/cost/cost-breakdown.tsx
  - apps/web/components/chat/chat-interface.tsx
autonomous: true

must_haves:
  truths:
    - "User sees cost breakdown per task after completion"
    - "Cost tracking aggregates token usage from OpenCode SDK events"
    - "Cost display shows input/output tokens and estimated cost"
  artifacts:
    - path: "apps/web/lib/cost-tracker.ts"
      provides: "Cost tracking utilities and aggregation logic"
      min_lines: 80
      exports: ["CostBreakdown", "aggregateCosts", "calculateCost"]
    - path: "apps/web/components/cost/cost-breakdown.tsx"
      provides: "Cost display component"
      min_lines: 40
      exports: ["CostBreakdown"]
  key_links:
    - from: "apps/web/components/chat/chat-interface.tsx"
      to: "apps/web/lib/cost-tracker.ts"
      via: "import aggregateCosts"
      pattern: "import.*cost-tracker"
---

<objective>
Create cost tracking system that aggregates token usage from OpenCode SDK events and displays cost breakdown per task.

Purpose: Provide visibility into AI costs per task, helping users understand resource usage and make informed decisions about model selection.
Output: Cost tracking utilities and cost breakdown display component
</objective>

<execution_context>
@/Users/dylansteck/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/dylansteck/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-real-time-ui-visibility/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create cost tracking utilities</name>
  <files>apps/web/lib/cost-tracker.ts</files>
  <action>
Create cost tracking utilities for aggregating token usage and calculating costs.

Export:
- CostBreakdown interface: { taskId: string, inputTokens: number, outputTokens: number, estimatedCost: number, model: string }
- aggregateCosts function: Takes array of SSE events, aggregates token counts per task
- calculateCost function: Takes input/output tokens and model name, returns estimated cost in USD

Cost calculation:
- Use approximate pricing: Claude Sonnet 4 ($3/$15 per 1M tokens input/output), Claude Opus ($15/$75), GPT-4 ($10/$30), etc.
- Default to Sonnet pricing if model unknown
- Round to 4 decimal places for display

Token aggregation:
- Track from SSE events: { type: 'tool-call', tokens: { input, output }, model: '...' }
- Group by taskId or messageId
- Sum input/output tokens separately

Reference RESEARCH.md Pattern 4 for implementation details.
</action>
  <verify>
File exists at apps/web/lib/cost-tracker.ts with CostBreakdown interface and aggregateCosts/calculateCost functions exported. Functions handle token aggregation and cost calculation correctly.
</verify>
  <done>
Cost tracking utilities created. Token aggregation and cost calculation functions work correctly. Supports multiple models with approximate pricing.
</done>
</task>

<task type="auto">
  <name>Task 2: Create CostBreakdown display component</name>
  <files>apps/web/components/cost/cost-breakdown.tsx</files>
  <action>
Create CostBreakdown component to display cost information.

Component should:
- Accept props: breakdown (CostBreakdown) or breakdowns (CostBreakdown[])
- Display: model name, input tokens, output tokens, estimated cost
- Format cost as currency ($X.XXXX)
- Format tokens with commas (1,234,567)
- Show per-task breakdown if multiple provided
- Use clean UI matching Ramp design (subtle borders, good spacing)

Follow existing component patterns. Use 'use client' directive. Style with Tailwind classes.

Reference existing component styling patterns from apps/web/components.
</action>
  <verify>
File exists at apps/web/components/cost/cost-breakdown.tsx with CostBreakdown component exported. Component displays cost breakdown with proper formatting. Tokens and cost formatted correctly.
</verify>
  <done>
CostBreakdown component created. Displays cost information with proper formatting. Shows model, tokens, and estimated cost.
</done>
</task>

<task type="auto">
  <name>Task 3: Integrate cost tracking into chat interface</name>
  <files>apps/web/components/chat/chat-interface.tsx</files>
  <action>
Enhance existing chat-interface.tsx to track costs from SSE events and display CostBreakdown.

When SSE events include token information:
- Import aggregateCosts from cost-tracker
- Track token events during streaming
- Aggregate costs per message/task
- Display CostBreakdown component after task completes (when 'done' event received)

Display cost breakdown:
- Show below completed assistant messages
- Or in session panel (can be added in later plan)
- Only show if cost data available

Preserve existing chat-interface functionality. Add cost state management and CostBreakdown rendering.

Reference existing chat-interface.tsx SSE handling and RESEARCH.md Pattern 4.
</action>
  <verify>
chat-interface.tsx imports cost tracking utilities. Token events tracked during streaming. CostBreakdown displays after task completion. Existing functionality preserved.
</verify>
  <done>
Cost tracking integrated into chat interface. Costs aggregate from SSE events. Cost breakdown displays after tasks complete.
</done>
</task>

</tasks>

<verification>
- Cost tracking utilities exist and calculate costs correctly
- CostBreakdown component displays cost information
- Chat interface tracks costs from SSE events
- Cost breakdown shows after task completion
</verification>

<success_criteria>
User sees cost breakdown per task after completion. Costs aggregate correctly from OpenCode SDK events. Cost display shows model, tokens, and estimated cost in readable format.
</success_criteria>

<output>
After completion, create `.planning/phases/04-real-time-ui-visibility/04-03-SUMMARY.md`
</output>
