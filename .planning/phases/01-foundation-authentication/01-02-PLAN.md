---
phase: 01-foundation-authentication
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - apps/api/src/db/schema.sql
  - apps/api/src/db/migrate.ts
  - apps/api/src/routes/users.ts
  - apps/api/src/index.ts
  - apps/api/wrangler.toml
  - packages/types/src/auth.ts
  - packages/types/src/user.ts
autonomous: true

must_haves:
  truths:
    - "D1 database has users, accounts, and sessions tables"
    - "API can create and retrieve users by GitHub ID"
    - "API can create and retrieve sessions"
  artifacts:
    - path: "apps/api/src/db/schema.sql"
      provides: "D1 database schema with Auth.js structure"
      contains: "CREATE TABLE users"
    - path: "apps/api/src/routes/users.ts"
      provides: "User CRUD endpoints"
      exports: ["usersRoutes"]
    - path: "packages/types/src/user.ts"
      provides: "User type definitions"
      exports: ["User", "CreateUserInput"]
  key_links:
    - from: "apps/api/src/routes/users.ts"
      to: "c.env.DB"
      via: "D1 database binding"
      pattern: "c\\.env\\.DB"
    - from: "apps/api/src/routes/users.ts"
      to: "packages/types/src/user.ts"
      via: "type import"
      pattern: "@ship/types"
---

<objective>
Set up D1 database schema and user management API

Purpose: Create the database foundation for authentication. Users, accounts (OAuth providers), and sessions tables following Auth.js D1 adapter schema. User API endpoints enable the OAuth callback to store and retrieve users.

Output:
- D1 schema with users, accounts, sessions, verification_tokens tables
- Migration script for local development
- User routes: POST /users/upsert, GET /users/:id
- Shared TypeScript types for User and related entities
</objective>

<execution_context>
@/Users/dylansteck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dylansteck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-authentication/01-CONTEXT.md
@.planning/phases/01-foundation-authentication/01-RESEARCH.md
@.planning/phases/01-foundation-authentication/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create D1 database schema and migration</name>
  <files>
    apps/api/src/db/schema.sql
    apps/api/src/db/migrate.ts
    apps/api/wrangler.toml
  </files>
  <action>
    Create D1 schema following Auth.js D1 adapter pattern (from research):

    1. apps/api/src/db/schema.sql:
       ```sql
       -- Auth.js standard schema adapted for Ship
       CREATE TABLE IF NOT EXISTS users (
         id TEXT PRIMARY KEY,
         github_id TEXT UNIQUE NOT NULL,
         username TEXT NOT NULL,
         email TEXT UNIQUE,
         name TEXT,
         avatar_url TEXT,
         created_at INTEGER NOT NULL DEFAULT (unixepoch()),
         updated_at INTEGER NOT NULL DEFAULT (unixepoch())
       );

       CREATE TABLE IF NOT EXISTS accounts (
         id TEXT PRIMARY KEY,
         user_id TEXT NOT NULL,
         provider TEXT NOT NULL,
         provider_account_id TEXT NOT NULL,
         access_token TEXT,
         refresh_token TEXT,
         expires_at INTEGER,
         token_type TEXT,
         scope TEXT,
         created_at INTEGER NOT NULL DEFAULT (unixepoch()),
         FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
         UNIQUE(provider, provider_account_id)
       );

       CREATE TABLE IF NOT EXISTS sessions (
         id TEXT PRIMARY KEY,
         user_id TEXT NOT NULL,
         expires_at INTEGER NOT NULL,
         created_at INTEGER NOT NULL DEFAULT (unixepoch()),
         FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
       );

       CREATE INDEX IF NOT EXISTS idx_users_github_id ON users(github_id);
       CREATE INDEX IF NOT EXISTS idx_accounts_user_id ON accounts(user_id);
       CREATE INDEX IF NOT EXISTS idx_sessions_user_id ON sessions(user_id);
       CREATE INDEX IF NOT EXISTS idx_sessions_expires_at ON sessions(expires_at);
       ```

    2. apps/api/src/db/migrate.ts:
       Script to run schema.sql against local D1 using Wrangler:
       ```typescript
       // Migration helper for local development
       // Run with: wrangler d1 execute ship-db --local --file=./src/db/schema.sql
       ```

    3. Update apps/api/wrangler.toml:
       - Ensure D1 binding is configured
       - Add migrations_dir if using Wrangler migrations
  </action>
  <verify>
    - `wrangler d1 execute ship-db --local --file=./src/db/schema.sql` succeeds
    - `wrangler d1 execute ship-db --local --command="SELECT name FROM sqlite_master WHERE type='table'"` shows tables
  </verify>
  <done>
    D1 database schema created with users, accounts, sessions tables
  </done>
</task>

<task type="auto">
  <name>Task 2: Create shared types and user API routes</name>
  <files>
    packages/types/src/auth.ts
    packages/types/src/user.ts
    packages/types/src/index.ts
    apps/api/src/routes/users.ts
    apps/api/src/index.ts
  </files>
  <action>
    Create TypeScript types in packages/types:

    1. packages/types/src/user.ts:
       ```typescript
       export interface User {
         id: string
         githubId: string
         username: string
         email: string | null
         name: string | null
         avatarUrl: string | null
         createdAt: number
         updatedAt: number
       }

       export interface CreateUserInput {
         githubId: string
         username: string
         email?: string
         name?: string
         avatarUrl?: string
       }

       export interface UserDTO {
         id: string
         username: string
         email: string | null
         name: string | null
         avatarUrl: string | null
       }
       ```

    2. packages/types/src/auth.ts:
       ```typescript
       export interface Session {
         id: string
         userId: string
         expiresAt: number
         createdAt: number
       }

       export interface Account {
         id: string
         userId: string
         provider: string
         providerAccountId: string
         accessToken: string | null
         refreshToken: string | null
         expiresAt: number | null
       }
       ```

    3. Update packages/types/src/index.ts to export all types

    4. apps/api/src/routes/users.ts:
       Hono router with:
       - POST /upsert: Create or update user by GitHub ID
         - Accept CreateUserInput
         - Return { userId, isNewUser }
         - Use D1 withSession for consistency
       - GET /:id: Get user by ID
         - Return UserDTO (no sensitive fields)
         - 404 if not found

    5. Update apps/api/src/index.ts:
       - Mount users routes at /users
       - Add Env type with DB binding
  </action>
  <verify>
    - TypeScript compiles without errors: `cd apps/api && pnpm type-check`
    - Start API: `cd apps/api && pnpm dev`
    - Create user: `curl -X POST http://localhost:8787/users/upsert -H "Content-Type: application/json" -d '{"githubId":"123","username":"test"}'`
    - Get user: `curl http://localhost:8787/users/{id}` returns user DTO
  </verify>
  <done>
    User API routes working with D1, shared types exported from @ship/types
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Database:
   - D1 local database has all 3 tables (users, accounts, sessions)
   - Indexes created for common queries

2. API:
   - POST /users/upsert creates new user, returns { userId, isNewUser: true }
   - POST /users/upsert with same githubId updates user, returns { userId, isNewUser: false }
   - GET /users/:id returns user DTO
   - GET /users/:id with invalid ID returns 404

3. Types:
   - @ship/types exports User, UserDTO, CreateUserInput, Session, Account
</verification>

<success_criteria>
- D1 schema deployed to local database
- User CRUD operations work through API
- TypeScript types shared between apps
- No sensitive data leaked in API responses (using DTOs)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-authentication/01-02-SUMMARY.md`
</output>
