---
phase: 01-foundation-authentication
plan: 05
type: execute
wave: 3
depends_on: ["01-01"]
files_modified:
  - apps/api/wrangler.toml
  - apps/api/.dev.vars.example
  - apps/web/.env.example
  - .github/workflows/deploy-api.yml
  - README.md
autonomous: true
user_setup:
  - service: cloudflare
    why: "Deploy API to Cloudflare Workers with D1 database"
    env_vars:
      - name: CLOUDFLARE_API_TOKEN
        source: "Cloudflare Dashboard -> My Profile -> API Tokens -> Create Token"
      - name: CLOUDFLARE_ACCOUNT_ID
        source: "Cloudflare Dashboard -> Workers & Pages -> Account ID (right sidebar)"
    dashboard_config:
      - task: "Create D1 database"
        location: "Cloudflare Dashboard -> Workers & Pages -> D1"
        details: "Create database named 'ship-db', copy database_id to wrangler.toml"
  - service: anthropic
    why: "LLM API key for agent operations (used by OpenCode SDK in Phase 3)"
    env_vars:
      - name: ANTHROPIC_API_KEY
        source: "https://console.anthropic.com/settings/keys"
    dashboard_config: []

must_haves:
  truths:
    - "API Worker has Anthropic API key configured as secret"
    - "D1 database binding is properly configured"
    - "Local development works with .dev.vars"
    - "Environment setup is documented"
  artifacts:
    - path: "apps/api/wrangler.toml"
      provides: "Complete Cloudflare Worker configuration"
      contains: "ANTHROPIC_API_KEY"
    - path: "apps/api/.dev.vars.example"
      provides: "Template for local development secrets"
      contains: "ANTHROPIC_API_KEY"
    - path: "apps/web/.env.example"
      provides: "Complete web app environment template"
      contains: "SESSION_SECRET"
  key_links:
    - from: "apps/api/wrangler.toml"
      to: "apps/api/src/index.ts"
      via: "Env bindings"
      pattern: "binding.*DB"
---

<objective>
Configure LLM API keys and finalize environment setup

Purpose: Complete the infrastructure setup by configuring Anthropic API keys as Cloudflare Worker secrets and documenting all environment variables. This prepares the system for agent operations in Phase 3 while keeping Phase 1 focused on auth foundation.

Output:
- Updated wrangler.toml with all bindings documented
- .dev.vars.example for local development
- Updated .env.example files with all required variables
- Documentation of environment setup in README
</objective>

<execution_context>
@/Users/dylansteck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dylansteck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-authentication/01-CONTEXT.md
@.planning/phases/01-foundation-authentication/01-RESEARCH.md
@.planning/phases/01-foundation-authentication/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure Cloudflare Worker environment</name>
  <files>
    apps/api/wrangler.toml
    apps/api/.dev.vars.example
    apps/api/src/env.d.ts
  </files>
  <action>
    Finalize Cloudflare Worker configuration:

    1. apps/api/wrangler.toml:
       ```toml
       name = "ship-api"
       main = "src/index.ts"
       compatibility_date = "2024-12-01"
       compatibility_flags = ["nodejs_compat"]

       # D1 Database
       [[d1_databases]]
       binding = "DB"
       database_name = "ship-db"
       database_id = "YOUR_D1_DATABASE_ID"  # Replace after creating D1 database

       # Environment variables (non-secret)
       [vars]
       ENVIRONMENT = "development"

       # Secrets (set via wrangler secret put):
       # - ANTHROPIC_API_KEY: LLM API key for agent operations
       # - API_SECRET: Internal API authentication between services

       # Production environment
       [env.production]
       vars = { ENVIRONMENT = "production" }

       # Staging environment
       [env.staging]
       vars = { ENVIRONMENT = "staging" }
       ```

    2. apps/api/.dev.vars.example:
       ```
       # Copy this to .dev.vars and fill in values
       # .dev.vars is gitignored - never commit secrets

       # Anthropic API key for LLM operations (Phase 3+)
       ANTHROPIC_API_KEY=sk-ant-api03-xxxxx

       # Internal API secret for service-to-service auth
       API_SECRET=your-internal-api-secret-here
       ```

    3. apps/api/src/env.d.ts:
       ```typescript
       interface Env {
         // D1 Database
         DB: D1Database

         // Environment variables
         ENVIRONMENT: string

         // Secrets (set via wrangler secret put)
         ANTHROPIC_API_KEY: string
         API_SECRET: string
       }
       ```

    4. Ensure .gitignore includes:
       - .dev.vars
       - .wrangler
  </action>
  <verify>
    - wrangler.toml has D1 binding configured
    - .dev.vars.example exists with all secrets documented
    - env.d.ts provides TypeScript types for bindings
    - `cd apps/api && pnpm dev` works with .dev.vars file
  </verify>
  <done>
    Cloudflare Worker environment fully configured with D1 and secrets
  </done>
</task>

<task type="auto">
  <name>Task 2: Update web app environment and documentation</name>
  <files>
    apps/web/.env.example
    README.md
  </files>
  <action>
    Complete environment documentation:

    1. apps/web/.env.example (comprehensive):
       ```
       # GitHub OAuth
       # Create at: https://github.com/settings/developers
       GITHUB_CLIENT_ID=
       GITHUB_CLIENT_SECRET=

       # Session encryption
       # Generate with: openssl rand -base64 32
       SESSION_SECRET=

       # API configuration
       API_BASE_URL=http://localhost:8787
       NEXT_PUBLIC_APP_URL=http://localhost:3000

       # For production:
       # API_BASE_URL=https://ship-api.your-subdomain.workers.dev
       # NEXT_PUBLIC_APP_URL=https://ship.yourdomain.com
       ```

    2. Update root README.md with development setup:
       ```markdown
       # Ship

       Background agent platform for building software with AI.

       ## Quick Start

       ### Prerequisites

       - Node.js 20+
       - pnpm 9+
       - Cloudflare account (for D1 database)
       - GitHub OAuth application

       ### Setup

       1. Install dependencies:
          ```bash
          pnpm install
          ```

       2. Configure web app environment:
          ```bash
          cp apps/web/.env.example apps/web/.env.local
          # Edit apps/web/.env.local with your values
          ```

       3. Configure API secrets (local development):
          ```bash
          cp apps/api/.dev.vars.example apps/api/.dev.vars
          # Edit apps/api/.dev.vars with your values
          ```

       4. Create D1 database:
          ```bash
          wrangler d1 create ship-db
          # Copy the database_id to apps/api/wrangler.toml
          ```

       5. Run database migrations:
          ```bash
          cd apps/api
          wrangler d1 execute ship-db --local --file=./src/db/schema.sql
          ```

       6. Start development:
          ```bash
          pnpm dev
          ```

       ### GitHub OAuth Setup

       1. Go to https://github.com/settings/developers
       2. Click "New OAuth App"
       3. Set Homepage URL: `http://localhost:3000`
       4. Set Callback URL: `http://localhost:3000/api/auth/github/callback`
       5. Copy Client ID and Client Secret to apps/web/.env.local

       ### Project Structure

       ```
       ship/
       ├── apps/
       │   ├── web/     # Next.js frontend
       │   └── api/     # Cloudflare Worker API
       └── packages/
           ├── ui/      # Shared UI components
           ├── types/   # Shared TypeScript types
           └── config/  # Shared tooling config
       ```

       ## Development

       - `pnpm dev` - Start all apps in development mode
       - `pnpm build` - Build all apps
       - `pnpm lint` - Lint all apps
       - `pnpm type-check` - Type check all apps
       ```
  </action>
  <verify>
    - README.md has complete setup instructions
    - .env.example files are comprehensive
    - Instructions are accurate and executable
  </verify>
  <done>
    Environment setup fully documented, ready for developers
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

Environment files:
- apps/api/wrangler.toml has D1, vars, and secrets documentation
- apps/api/.dev.vars.example has all secrets listed
- apps/web/.env.example has all variables listed
- Root README.md has complete setup guide

Fresh clone test (conceptual):
1. Clone repo
2. Copy .env.example files
3. Create GitHub OAuth app, add credentials
4. Create D1 database, update wrangler.toml
5. Run migrations
6. pnpm dev works
7. OAuth flow completes
</verification>

<success_criteria>
- All environment variables documented
- LLM API key (Anthropic) configured as Worker secret
- Local development setup is clear and documented
- README provides complete onboarding path
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-authentication/01-05-SUMMARY.md`
</output>
