---
phase: 05-external-integrations
plan: 04
type: execute
wave: 2
depends_on: [05-01]
files_modified:
  - apps/api/src/routes/git.ts
  - apps/api/src/routes/webhooks.ts
  - apps/api/src/lib/github.ts
autonomous: true

must_haves:
  truths:
    - "System links GitHub PRs to Linear issues ONLY when Linear issue is explicitly linked to session"
    - "GitHub webhook handler verifies signatures"
    - "PR URLs stored in Linear issue descriptions or comments when linked"
  artifacts:
    - path: "apps/api/src/routes/webhooks.ts"
      provides: "GitHub webhook handler"
      min_lines: 80
      exports: ["POST /webhooks/github"]
    - path: "apps/api/src/lib/github.ts"
      provides: "GitHub PR linking utilities"
      contains: "linkPRToLinearIssue"
  key_links:
    - from: "apps/api/src/routes/webhooks.ts"
      to: "apps/api/src/lib/github.ts"
      via: "import linkPRToLinearIssue"
      pattern: "linkPRToLinearIssue"
---

<objective>
Implement GitHub webhook handler and conditional PR-to-Linear issue linking.

Purpose: Link GitHub PRs created by agent to Linear issues, but ONLY when a Linear issue is explicitly linked to the session. Provides traceability when user chooses to link issues.
Output: GitHub webhook handler, conditional PR linking logic, and Linear issue updates
</objective>

<execution_context>
@/Users/dylansteck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dylansteck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-external-integrations/05-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub webhook handler</name>
  <files>apps/api/src/routes/webhooks.ts</files>
  <action>
Create GitHub webhook handler for PR events.

Handler:
- POST /webhooks/github - Receives GitHub webhook events
- Verify webhook signature using GitHub secret (HMAC SHA256)
- Handle event types: pull_request.opened, pull_request.closed
- Extract PR URL, number, and session ID from webhook payload
- Call PR linking logic for opened PRs

Webhook verification:
- Get GitHub webhook secret from environment
- Verify X-Hub-Signature-256 header matches payload
- Reject if signature invalid

Follow RESEARCH.md Pattern 3 for webhook verification. Use @octokit/webhooks for signature verification if available.
</action>
  <verify>
GitHub webhook handler exists. Verifies signatures correctly. Handles PR events. Extracts PR data from payload.
</verify>
  <done>
GitHub webhook handler created. PR events received and verified securely.
</done>
</task>

<task type="auto">
  <name>Task 2: Add PR-to-Linear issue linking</name>
  <files>apps/api/src/lib/github.ts, apps/api/src/lib/linear.ts</files>
  <action>
Add utilities for linking GitHub PRs to Linear issues.

Functions:
- linkPRToLinearIssue(prUrl, sessionId) - Link PR to Linear issue from session
- findLinearIssueForSession(sessionId) - Find Linear issue linked to session
- updateLinearIssueWithPR(issueId, prUrl) - Add PR URL to Linear issue

Linking logic:
- Query SessionDO for linked Linear issue ID (getLinearIssueId())
- ONLY if linearIssueId exists, add PR URL to issue description or comments
- Use Linear GraphQL mutation to update issue
- Store PR URL in issue for traceability
- If no linked Linear issue, skip linking entirely (no-op)

Reference RESEARCH.md Pattern 1 for Linear GraphQL mutations.
</action>
  <verify>
PR linking functions exist. Find Linear issue from session. Update Linear issue with PR URL. Handles missing Linear issue gracefully.
</verify>
  <done>
PR-to-Linear issue linking created. PRs automatically linked to corresponding Linear issues.
</done>
</task>

<task type="auto">
  <name>Task 3: Integrate PR linking into git workflow</name>
  <files>apps/api/src/routes/git.ts</files>
  <action>
Integrate PR linking into existing git workflow.

When PR created:
- After PR creation in git.ts, check if session has explicitly linked Linear issue
- ONLY if linearIssueId exists in session metadata, call linkPRToLinearIssue()
- Store PR URL in Linear issue description or comments
- If no linked Linear issue, skip linking (no-op)

Preserve existing git workflow functionality. Add Linear linking as conditional side effect only when Linear issue is explicitly linked (don't fail PR creation if Linear linking fails or if no issue linked).

Follow existing git.ts patterns. Reference existing PR creation code.
</action>
  <verify>
PR creation triggers Linear issue linking. PR URLs added to Linear issues. Linking failures don't break PR creation.
</verify>
  <done>
PR linking integrated into git workflow. PRs automatically linked to Linear issues on creation.
</done>
</task>

</tasks>

<verification>
- GitHub webhook handler verifies signatures
- PRs link to Linear issues ONLY when Linear issue is explicitly linked
- PR URLs stored in Linear issue descriptions/comments when linked
- No linking occurs if no Linear issue is linked to session
</verification>

<success_criteria>
System links GitHub PRs to Linear issues ONLY when Linear issue is explicitly linked to session. Webhook handler provides real-time PR linking with proper security.
</success_criteria>

<output>
After completion, create `.planning/phases/05-external-integrations/05-04-SUMMARY.md`
</output>
