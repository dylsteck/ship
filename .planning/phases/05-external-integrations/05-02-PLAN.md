---
phase: 05-external-integrations
plan: 02
type: execute
wave: 1
depends_on: [05-01]
files_modified:
  - apps/api/src/routes/linear.ts
  - apps/api/src/lib/linear.ts
  - apps/api/src/durable-objects/session.ts
autonomous: true

must_haves:
  truths:
    - "User can manually link Linear issues to sessions"
    - "User can manually sync Linear issues to create tasks"
    - "Linear issue linking stored in session metadata"
  artifacts:
    - path: "apps/api/src/routes/linear.ts"
      provides: "Linear linking and manual sync endpoints"
      contains: "linkLinearIssue, syncIssuesToSession"
    - path: "apps/api/src/lib/linear.ts"
      provides: "Linear linking utilities"
      contains: "linkLinearIssueToSession"
    - path: "apps/api/src/durable-objects/session.ts"
      provides: "SessionDO with Linear issue linking"
      contains: "linkLinearIssue, getLinearIssueId"
  key_links:
    - from: "apps/api/src/routes/linear.ts"
      to: "apps/api/src/lib/linear.ts"
      via: "import syncIssuesToSession"
      pattern: "syncIssuesToSession"
---

<objective>
Implement manual Linear issue linking and optional sync for user-initiated task creation.

Purpose: Enable users to explicitly link Linear issues to sessions and optionally sync issues to create tasks when they choose to.
Output: Linear issue linking API, manual sync endpoint, and session metadata storage
</objective>

<execution_context>
@/Users/dylansteck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dylansteck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-external-integrations/05-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Linear issue linking utilities</name>
  <files>apps/api/src/lib/linear.ts</files>
  <action>
Add utilities for linking Linear issues to sessions.

Functions:
- linkLinearIssueToSession(sessionId, linearIssueId) - Link Linear issue to session
- getLinkedLinearIssue(sessionId) - Get linked Linear issue ID for session
- syncIssuesToSession(userId, sessionId) - OPTIONAL: Manual sync to create tasks from Linear issues

Linking logic:
- Store linearIssueId in SessionDO metadata
- Query Linear API to verify issue exists and user has access
- Return success/failure

Sync logic (optional, user-initiated):
- Query Linear for user's assigned issues
- Create tasks in SessionDO for each issue (if user requests sync)
- Store Linear issue ID in task metadata

Follow existing metadata storage patterns from SessionDO. Reference RESEARCH.md Pattern 1 for Linear GraphQL queries.
</action>
  <verify>
linkLinearIssueToSession function exists. Stores Linear issue ID in session metadata. Verifies issue access. Optional sync works when requested.
</verify>
  <done>
Linear linking utilities created. Users can explicitly link Linear issues to sessions.
</done>
</task>

<task type="auto">
  <name>Task 2: Add Linear linking API endpoints</name>
  <files>apps/api/src/routes/linear.ts</files>
  <action>
Add API endpoints for Linear issue linking and optional sync.

Routes:
- POST /linear/link/:sessionId - Link Linear issue to session
  - Body: { linearIssueId: string }
  - Verifies Linear account connected
  - Calls linkLinearIssueToSession()
  - Returns success status
- GET /linear/link/:sessionId - Get linked Linear issue for session
  - Returns linearIssueId if linked, null otherwise
- POST /linear/sync/:sessionId - OPTIONAL: Manual sync Linear issues to create tasks
  - Requires Linear account connected
  - Calls syncIssuesToSession() only when user explicitly requests
  - Returns count of issues synced

All routes require Linear account connection. Handle errors gracefully.

Follow existing route patterns. Use Hono router.
</action>
  <verify>
Linear linking endpoints exist. Link endpoint stores issue ID. Get endpoint retrieves linked issue. Manual sync endpoint works on request only.
</verify>
  <done>
Linear linking API endpoints created. Users can explicitly link issues and optionally sync.
</done>
</task>

<task type="auto">
  <name>Task 3: Add session metadata storage for Linear issue</name>
  <files>apps/api/src/durable-objects/session.ts</files>
  <action>
Add methods to SessionDO for storing and retrieving linked Linear issue.

Methods:
- linkLinearIssue(linearIssueId) - Store Linear issue ID in session metadata
- getLinearIssueId() - Retrieve linked Linear issue ID
- clearLinearIssue() - Remove Linear issue link

Storage:
- Store linearIssueId in SessionDO SQLite storage
- Key: 'linearIssueId'
- Persist across hibernation

Preserve existing SessionDO functionality. Add Linear linking as optional feature.

Follow existing metadata storage patterns in SessionDO.
</action>
  <verify>
SessionDO has linkLinearIssue, getLinearIssueId methods. Linear issue ID stored in metadata. Persists across hibernation.
</verify>
  <done>
SessionDO Linear linking methods created. Linked Linear issues persist in session metadata.
</done>
</task>

</tasks>

<verification>
- Users can explicitly link Linear issues to sessions
- Linked Linear issue ID stored in session metadata
- Manual sync endpoint works when user requests it
- Linear issue linking persists across session hibernation
</verification>

<success_criteria>
User can explicitly link Linear issues to sessions. Manual sync available for optional task creation. Linear issue linking stored in session metadata.
</success_criteria>

<output>
After completion, create `.planning/phases/05-external-integrations/05-02-SUMMARY.md`
</output>
