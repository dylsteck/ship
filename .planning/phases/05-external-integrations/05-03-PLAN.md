---
phase: 05-external-integrations
plan: 03
type: execute
wave: 2
depends_on: [05-01, 05-02]
files_modified:
  - apps/api/src/lib/linear.ts
  - apps/api/src/lib/agent-executor.ts
  - apps/api/src/durable-objects/session.ts
autonomous: true

must_haves:
  truths:
    - "Agent updates Linear issue status ONLY when Linear issue is explicitly linked to session"
    - "Agent can create new Linear issues when user asks or agent discovers bugs"
    - "Linear issue updates use proper GraphQL mutations"
  artifacts:
    - path: "apps/api/src/lib/linear.ts"
      provides: "Linear issue update and creation methods"
      contains: "updateIssueStatus, createIssue"
    - path: "apps/api/src/lib/agent-executor.ts"
      provides: "Agent executor with conditional Linear integration hooks"
      contains: "onTaskComplete (checks for linked issue)"
    - path: "apps/api/src/durable-objects/session.ts"
      provides: "SessionDO with Linear issue linking check"
      contains: "getLinearIssueId, hasLinkedLinearIssue"
  key_links:
    - from: "apps/api/src/lib/agent-executor.ts"
      to: "apps/api/src/lib/linear.ts"
      via: "import updateIssueStatus"
      pattern: "updateIssueStatus"
---

<objective>
Integrate Linear issue updates into agent execution lifecycle, but ONLY when Linear issue is explicitly linked.

Purpose: Update Linear issues when agent tasks complete or fail, but only if user explicitly linked a Linear issue to the session. Enable agent to create Linear issues when user asks or agent discovers bugs.
Output: Conditional Linear issue status updates, issue creation from agent, and explicit linking check
</objective>

<execution_context>
@/Users/dylansteck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dylansteck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-external-integrations/05-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Linear issue update methods</name>
  <files>apps/api/src/lib/linear.ts</files>
  <action>
Add methods for updating and creating Linear issues.

Methods:
- updateIssueStatus(issueId, status) - Update issue state (e.g., "In Progress" → "Done")
- createIssue(title, description, teamId) - Create new Linear issue
- linkIssueToPR(issueId, prUrl) - Add PR URL to issue description/comments

Status mapping:
- Task complete → Linear "Done" state
- Task failed → Linear "Canceled" or "In Review" state
- Task in progress → Linear "In Progress" state

Use Linear GraphQL mutations. Handle Linear state IDs correctly (states are team-specific).

Reference RESEARCH.md Pattern 1 for Linear GraphQL mutations.
</action>
  <verify>
updateIssueStatus and createIssue methods exist. Handle Linear state IDs correctly. Link PRs to issues.
</verify>
  <done>
Linear issue update methods created. Status updates and issue creation work correctly.
</done>
</task>

<task type="auto">
  <name>Task 2: Integrate conditional Linear updates into agent executor</name>
  <files>apps/api/src/lib/agent-executor.ts</files>
  <action>
Add Linear integration hooks to agent executor, but ONLY if Linear issue is explicitly linked.

Hooks:
- onTaskComplete(sessionId, taskId) - Check if session has linked Linear issue, if yes update to "Done"
- onTaskError(sessionId, taskId, error) - Check if session has linked Linear issue, if yes update to "Canceled" or add error comment
- onTaskStart(sessionId, taskId) - Check if session has linked Linear issue, if yes update to "In Progress"

Linking check:
- Query SessionDO for linked Linear issue ID (getLinearIssueId())
- ONLY if linearIssueId exists, call Linear API to update issue
- If no linked issue, skip Linear update (no-op)
- Handle errors gracefully (don't fail task if Linear update fails)

Preserve existing agent executor functionality. Add Linear calls as conditional side effects only when explicitly linked.
</action>
  <verify>
Agent executor checks for linked Linear issue before updating. Only updates Linear if issue is explicitly linked. Handles errors gracefully. Skips update if no linked issue.
</verify>
  <done>
Conditional Linear integration added to agent executor. Linear issues updated ONLY when explicitly linked to session.
</done>
</task>

<task type="auto">
  <name>Task 3: Add Linear issue creation from agent</name>
  <files>apps/api/src/lib/agent-executor.ts, apps/api/src/lib/linear.ts</files>
  <action>
Enable agent to create Linear issues when discovering bugs or suggesting improvements.

Pattern:
- Agent detects bug/improvement opportunity during execution
- Calls createLinearIssue tool (via OpenCode SDK custom tool)
- Tool creates Linear issue with title, description, team ID
- Returns issue ID and URL

Custom tool registration:
- Register createLinearIssue tool with OpenCode SDK
- Tool accepts: title, description, teamId (optional, default to user's default team)
- Tool implementation calls LinearClient.createIssue()
- Returns issue data for agent to reference

Follow existing custom tool patterns. Reference OpenCode SDK tool registration docs.
</action>
  <verify>
createLinearIssue tool registered with OpenCode SDK. Agent can create Linear issues. Tool returns issue ID and URL.
</verify>
  <done>
Linear issue creation tool added. Agent can create issues for bugs and improvements.
</done>
</task>

</tasks>

<verification>
- Agent updates Linear issue status on task completion ONLY if Linear issue is explicitly linked
- Agent updates Linear issue status on task failure ONLY if Linear issue is explicitly linked
- Agent can create Linear issues via custom tool when user asks or discovers bugs
- Linear issue updates use correct state IDs
- No Linear updates occur if no issue is linked
</verification>

<success_criteria>
Agent updates Linear issue status when tasks complete or fail, but ONLY when Linear issue is explicitly linked to session. Agent can create new Linear issues when user asks or when discovering bugs.
</success_criteria>

<output>
After completion, create `.planning/phases/05-external-integrations/05-03-SUMMARY.md`
</output>
